# Addon Development (Statamic-Style)

Learn how to build powerful, distributable addons for Cartino inspired by Statamic CMS's excellent addon architecture.

## Introduction

Cartino's addon system allows you to:
- ðŸ“¦ **Package functionality** - Self-contained, installable packages
- ðŸ”Œ **Hook into core** - Extend models, controllers, routes
- ðŸŽ¨ **Add admin UI** - Custom pages, components, widgets
- ðŸ—„ï¸ **Manage data** - Migrations, seeders, models
- âš™ï¸ **Provide settings** - Configurable via admin
- ðŸ“ **Include documentation** - README and guides
- ðŸ§ª **Include tests** - PHPUnit and Pest tests

## Addon Types

### 1. Feature Addons
Add new functionality to Cartino:
- **Reviews** - Product review system
- **Wishlists** - Save favorite products
- **Subscriptions** - Recurring billing
- **Gift Cards** - Digital gift cards

### 2. Integration Addons
Connect external services:
- **Mailchimp** - Email marketing sync
- **Stripe** - Advanced payment features
- **ShipStation** - Shipping automation
- **Google Analytics** - Enhanced tracking

### 3. Admin Addons
Extend admin panel:
- **Analytics Dashboard** - Sales reports
- **Bulk Editor** - Mass edit products
- **Import/Export** - CSV tools
- **Activity Log** - Track changes

### 4. Field Type Addons
Custom blueprint fields:
- **Color Picker** - Advanced color selection
- **Location** - Map picker
- **Rich Text** - WYSIWYG editor
- **Relationship** - Advanced relationships

## Creating an Addon

### Initialize Addon

```bash
php artisan cartino:make-addon Reviews
```

This creates:

```
packages/
â””â”€â”€ reviews/
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ ReviewsServiceProvider.php
    â”‚   â”œâ”€â”€ Models/
    â”‚   â”‚   â””â”€â”€ Review.php
    â”‚   â”œâ”€â”€ Http/
    â”‚   â”‚   â”œâ”€â”€ Controllers/
    â”‚   â”‚   â””â”€â”€ Resources/
    â”‚   â”œâ”€â”€ Policies/
    â”‚   â””â”€â”€ Database/
    â”‚       â”œâ”€â”€ migrations/
    â”‚       â””â”€â”€ seeders/
    â”œâ”€â”€ resources/
    â”‚   â”œâ”€â”€ views/
    â”‚   â”œâ”€â”€ js/
    â”‚   â”‚   â”œâ”€â”€ Pages/
    â”‚   â”‚   â””â”€â”€ Components/
    â”‚   â””â”€â”€ lang/
    â”œâ”€â”€ routes/
    â”‚   â”œâ”€â”€ web.php
    â”‚   â”œâ”€â”€ api.php
    â”‚   â””â”€â”€ admin.php
    â”œâ”€â”€ config/
    â”‚   â””â”€â”€ reviews.php
    â”œâ”€â”€ tests/
    â”œâ”€â”€ composer.json
    â”œâ”€â”€ package.json
    â””â”€â”€ README.md
```

## Addon Structure

### Service Provider

```php
// src/ReviewsServiceProvider.php
namespace Cartino\Reviews;

use Illuminate\Support\ServiceProvider;
use Cartino\Reviews\Models\Review;
use Cartino\Reviews\Policies\ReviewPolicy;

class ReviewsServiceProvider extends ServiceProvider
{
    public function register(): void
    {
        // Merge config
        $this->mergeConfigFrom(
            __DIR__.'/../config/reviews.php',
            'reviews'
        );
    }

    public function boot(): void
    {
        // Load routes
        $this->loadRoutesFrom(__DIR__.'/../routes/web.php');
        $this->loadRoutesFrom(__DIR__.'/../routes/api.php');
        $this->loadRoutesFrom(__DIR__.'/../routes/admin.php');

        // Load views
        $this->loadViewsFrom(__DIR__.'/../resources/views', 'reviews');

        // Load migrations
        $this->loadMigrationsFrom(__DIR__.'/Database/migrations');

        // Load translations
        $this->loadTranslationsFrom(__DIR__.'/../resources/lang', 'reviews');

        // Register policies
        Gate::policy(Review::class, ReviewPolicy::class);

        // Publish assets
        if ($this->app->runningInConsole()) {
            $this->publishes([
                __DIR__.'/../config/reviews.php' => config_path('reviews.php'),
            ], 'reviews-config');

            $this->publishes([
                __DIR__.'/../resources/views' => resource_path('views/vendor/reviews'),
            ], 'reviews-views');

            $this->publishes([
                __DIR__.'/../resources/js' => resource_path('js/vendor/reviews'),
            ], 'reviews-js');
        }

        // Register addon with Cartino
        $this->app['cartino.addons']->register('reviews', [
            'name' => 'Reviews',
            'description' => 'Product review system',
            'version' => '1.0.0',
            'author' => 'Your Name',
            'provider' => self::class,
        ]);

        // Hook into events
        $this->registerEventListeners();

        // Register admin navigation
        $this->registerAdminNavigation();

        // Register permissions
        $this->registerPermissions();
    }

    protected function registerEventListeners(): void
    {
        // Listen to product events
        Event::listen(
            \Cartino\Events\ProductCreated::class,
            \Cartino\Reviews\Listeners\CreateReviewSettings::class
        );
    }

    protected function registerAdminNavigation(): void
    {
        $this->app['cartino.admin']->navigation()->add([
            'label' => 'Reviews',
            'icon' => 'star',
            'route' => 'admin.reviews.index',
            'permission' => 'reviews:view',
            'order' => 50,
        ]);
    }

    protected function registerPermissions(): void
    {
        Permission::create(['name' => 'reviews:view']);
        Permission::create(['name' => 'reviews:create']);
        Permission::create(['name' => 'reviews:edit']);
        Permission::create(['name' => 'reviews:delete']);
        Permission::create(['name' => 'reviews:moderate']);
    }
}
```

### Composer Configuration

```json
{
  "name": "cartino/reviews",
  "description": "Product review system for Cartino",
  "type": "library",
  "keywords": ["cartino", "addon", "reviews", "e-commerce"],
  "license": "MIT",
  "authors": [
    {
      "name": "Your Name",
      "email": "[email protected]"
    }
  ],
  "require": {
    "php": "^8.2",
    "illuminate/support": "^11.0",
    "cartino/framework": "^1.0"
  },
  "require-dev": {
    "orchestra/testbench": "^9.0",
    "pestphp/pest": "^2.0"
  },
  "autoload": {
    "psr-4": {
      "Cartino\\Reviews\\": "src/"
    }
  },
  "autoload-dev": {
    "psr-4": {
      "Cartino\\Reviews\\Tests\\": "tests/"
    }
  },
  "extra": {
    "laravel": {
      "providers": [
        "Cartino\\Reviews\\ReviewsServiceProvider"
      ]
    },
    "cartino": {
      "addon": true,
      "handle": "reviews"
    }
  },
  "minimum-stability": "dev",
  "prefer-stable": true
}
```

## Models

### Review Model

```php
// src/Models/Review.php
namespace Cartino\Reviews\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\SoftDeletes;
use Cartino\Models\Product;
use Cartino\Models\Customer;

class Review extends Model
{
    use SoftDeletes;

    protected $fillable = [
        'product_id',
        'customer_id',
        'rating',
        'title',
        'body',
        'is_verified_purchase',
        'is_approved',
        'helpful_count',
        'unhelpful_count',
    ];

    protected $casts = [
        'rating' => 'integer',
        'is_verified_purchase' => 'boolean',
        'is_approved' => 'boolean',
        'helpful_count' => 'integer',
        'unhelpful_count' => 'integer',
    ];

    // Relationships
    public function product(): BelongsTo
    {
        return $this->belongsTo(Product::class);
    }

    public function customer(): BelongsTo
    {
        return $this->belongsTo(Customer::class);
    }

    // Scopes
    public function scopeApproved($query)
    {
        return $query->where('is_approved', true);
    }

    public function scopeVerified($query)
    {
        return $query->where('is_verified_purchase', true);
    }

    public function scopeRating($query, int $rating)
    {
        return $query->where('rating', $rating);
    }

    // Accessors
    public function getAverageRatingAttribute(): float
    {
        return round($this->rating, 1);
    }

    // Methods
    public function approve(): bool
    {
        return $this->update(['is_approved' => true]);
    }

    public function reject(): bool
    {
        return $this->update(['is_approved' => false]);
    }

    public function markHelpful(): void
    {
        $this->increment('helpful_count');
    }

    public function markUnhelpful(): void
    {
        $this->increment('unhelpful_count');
    }
}
```

## Migrations

```php
// src/Database/migrations/2025_01_01_000000_create_reviews_table.php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('reviews', function (Blueprint $table) {
            $table->id();
            $table->foreignId('product_id')->constrained()->cascadeOnDelete();
            $table->foreignId('customer_id')->constrained()->cascadeOnDelete();
            $table->unsignedTinyInteger('rating'); // 1-5
            $table->string('title');
            $table->text('body');
            $table->boolean('is_verified_purchase')->default(false);
            $table->boolean('is_approved')->default(false);
            $table->unsignedInteger('helpful_count')->default(0);
            $table->unsignedInteger('unhelpful_count')->default(0);
            $table->timestamps();
            $table->softDeletes();

            $table->index(['product_id', 'is_approved']);
            $table->index('rating');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('reviews');
    }
};
```

## Controllers

### API Controller

```php
// src/Http/Controllers/ReviewController.php
namespace Cartino\Reviews\Http\Controllers;

use Cartino\Http\Controllers\Controller;
use Cartino\Reviews\Models\Review;
use Cartino\Reviews\Http\Requests\StoreReviewRequest;
use Cartino\Reviews\Http\Resources\ReviewResource;
use Illuminate\Http\Resources\Json\AnonymousResourceCollection;
use Spatie\QueryBuilder\QueryBuilder;

class ReviewController extends Controller
{
    public function index(): AnonymousResourceCollection
    {
        $reviews = QueryBuilder::for(Review::class)
            ->allowedFilters(['product_id', 'customer_id', 'rating'])
            ->allowedIncludes(['product', 'customer'])
            ->allowedSorts(['rating', 'helpful_count', 'created_at'])
            ->defaultSort('-created_at')
            ->paginate();

        return ReviewResource::collection($reviews);
    }

    public function store(StoreReviewRequest $request)
    {
        $review = Review::create([
            'product_id' => $request->product_id,
            'customer_id' => auth('customer')->id(),
            'rating' => $request->rating,
            'title' => $request->title,
            'body' => $request->body,
            'is_verified_purchase' => $this->isVerifiedPurchase(
                $request->product_id,
                auth('customer')->id()
            ),
        ]);

        return new ReviewResource($review);
    }

    protected function isVerifiedPurchase(int $productId, int $customerId): bool
    {
        return Order::where('customer_id', $customerId)
            ->whereHas('items', function ($query) use ($productId) {
                $query->where('product_id', $productId);
            })
            ->exists();
    }
}
```

### Admin Controller

```php
// src/Http/Controllers/Admin/ReviewController.php
namespace Cartino\Reviews\Http\Controllers\Admin;

use Cartino\Http\Controllers\Controller;
use Cartino\Reviews\Models\Review;
use Inertia\Inertia;
use Inertia\Response;

class ReviewController extends Controller
{
    public function index(): Response
    {
        $this->authorize('reviews:view');

        $reviews = Review::with(['product', 'customer'])
            ->latest()
            ->paginate(20);

        return Inertia::render('Reviews/Index', [
            'reviews' => $reviews,
            'stats' => [
                'total' => Review::count(),
                'pending' => Review::where('is_approved', false)->count(),
                'approved' => Review::where('is_approved', true)->count(),
                'average_rating' => Review::avg('rating'),
            ],
        ]);
    }

    public function approve(Review $review)
    {
        $this->authorize('reviews:moderate');

        $review->approve();

        return redirect()->back()->with('success', 'Review approved');
    }

    public function reject(Review $review)
    {
        $this->authorize('reviews:moderate');

        $review->reject();

        return redirect()->back()->with('success', 'Review rejected');
    }

    public function destroy(Review $review)
    {
        $this->authorize('reviews:delete');

        $review->delete();

        return redirect()->back()->with('success', 'Review deleted');
    }
}
```

## Vue Components

### Admin Review Index Page

```vue
<!-- resources/js/Pages/Reviews/Index.vue -->
<script setup lang="ts">
import { ref } from 'vue'
import { router } from '@inertiajs/vue3'
import AdminLayout from '@/Layouts/AdminLayout.vue'
import { StarIcon } from '@heroicons/vue/24/solid'
import Button from '@/Components/UI/Button.vue'

interface Review {
  id: number
  product: {
    name: string
  }
  customer: {
    name: string
  }
  rating: number
  title: string
  body: string
  is_approved: boolean
  created_at: string
}

const props = defineProps<{
  reviews: {
    data: Review[]
  }
  stats: {
    total: number
    pending: number
    approved: number
    average_rating: number
  }
}>()

const approveReview = (id: number) => {
  router.post(`/admin/reviews/${id}/approve`, {}, {
    preserveScroll: true,
  })
}

const rejectReview = (id: number) => {
  router.post(`/admin/reviews/${id}/reject`, {}, {
    preserveScroll: true,
  })
}

const deleteReview = (id: number) => {
  if (confirm('Are you sure you want to delete this review?')) {
    router.delete(`/admin/reviews/${id}`, {
      preserveScroll: true,
    })
  }
}
</script>

<template>
  <AdminLayout title="Reviews">
    <div class="space-y-6">
      <!-- Stats -->
      <div class="grid grid-cols-1 gap-6 md:grid-cols-4">
        <div class="rounded-lg bg-white p-6 shadow">
          <h3 class="text-sm font-medium text-gray-500">Total Reviews</h3>
          <p class="mt-2 text-3xl font-bold">{{ stats.total }}</p>
        </div>

        <div class="rounded-lg bg-white p-6 shadow">
          <h3 class="text-sm font-medium text-gray-500">Pending</h3>
          <p class="mt-2 text-3xl font-bold text-yellow-600">{{ stats.pending }}</p>
        </div>

        <div class="rounded-lg bg-white p-6 shadow">
          <h3 class="text-sm font-medium text-gray-500">Approved</h3>
          <p class="mt-2 text-3xl font-bold text-green-600">{{ stats.approved }}</p>
        </div>

        <div class="rounded-lg bg-white p-6 shadow">
          <h3 class="text-sm font-medium text-gray-500">Average Rating</h3>
          <div class="mt-2 flex items-center">
            <p class="text-3xl font-bold">{{ stats.average_rating.toFixed(1) }}</p>
            <StarIcon class="ml-2 h-8 w-8 text-yellow-400" />
          </div>
        </div>
      </div>

      <!-- Reviews List -->
      <div class="rounded-lg bg-white shadow">
        <div class="px-6 py-4 border-b">
          <h2 class="text-lg font-medium">Reviews</h2>
        </div>

        <div class="divide-y">
          <div
            v-for="review in reviews.data"
            :key="review.id"
            class="p-6 hover:bg-gray-50"
          >
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center space-x-2">
                  <div class="flex">
                    <StarIcon
                      v-for="i in 5"
                      :key="i"
                      :class="[
                        'h-5 w-5',
                        i <= review.rating ? 'text-yellow-400' : 'text-gray-300',
                      ]"
                    />
                  </div>

                  <span
                    :class="[
                      'rounded-full px-2 py-1 text-xs font-medium',
                      review.is_approved
                        ? 'bg-green-100 text-green-800'
                        : 'bg-yellow-100 text-yellow-800',
                    ]"
                  >
                    {{ review.is_approved ? 'Approved' : 'Pending' }}
                  </span>
                </div>

                <h3 class="mt-2 font-medium text-gray-900">{{ review.title }}</h3>
                <p class="mt-1 text-gray-600">{{ review.body }}</p>

                <div class="mt-3 flex items-center space-x-4 text-sm text-gray-500">
                  <span>{{ review.customer.name }}</span>
                  <span>â€¢</span>
                  <span>{{ review.product.name }}</span>
                  <span>â€¢</span>
                  <span>{{ new Date(review.created_at).toLocaleDateString() }}</span>
                </div>
              </div>

              <div class="ml-4 flex space-x-2">
                <Button
                  v-if="!review.is_approved"
                  size="sm"
                  @click="approveReview(review.id)"
                >
                  Approve
                </Button>

                <Button
                  v-if="review.is_approved"
                  size="sm"
                  variant="secondary"
                  @click="rejectReview(review.id)"
                >
                  Reject
                </Button>

                <Button
                  size="sm"
                  variant="danger"
                  @click="deleteReview(review.id)"
                >
                  Delete
                </Button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </AdminLayout>
</template>
```

## Configuration

```php
// config/reviews.php
return [
    /*
    |--------------------------------------------------------------------------
    | Auto-approve Reviews
    |--------------------------------------------------------------------------
    |
    | Automatically approve reviews from verified purchases.
    */
    'auto_approve_verified' => env('REVIEWS_AUTO_APPROVE_VERIFIED', false),

    /*
    |--------------------------------------------------------------------------
    | Moderation
    |--------------------------------------------------------------------------
    |
    | Reviews must be approved before being visible.
    */
    'require_approval' => env('REVIEWS_REQUIRE_APPROVAL', true),

    /*
    |--------------------------------------------------------------------------
    | Minimum Rating
    |--------------------------------------------------------------------------
    |
    | Minimum allowed rating (1-5).
    */
    'min_rating' => 1,

    /*
    |--------------------------------------------------------------------------
    | Maximum Rating
    |--------------------------------------------------------------------------
    |
    | Maximum allowed rating (1-5).
    */
    'max_rating' => 5,

    /*
    |--------------------------------------------------------------------------
    | Review Length
    |--------------------------------------------------------------------------
    */
    'title_min_length' => 10,
    'title_max_length' => 255,
    'body_min_length' => 50,
    'body_max_length' => 5000,

    /*
    |--------------------------------------------------------------------------
    | Helpful Votes
    |--------------------------------------------------------------------------
    |
    | Allow customers to mark reviews as helpful.
    */
    'enable_helpful_votes' => true,

    /*
    |--------------------------------------------------------------------------
    | Notifications
    |--------------------------------------------------------------------------
    |
    | Send notifications to admins when new reviews are submitted.
    */
    'notify_admins' => true,
    'admin_emails' => [
        '[email protected]',
    ],
];
```

## Testing

```php
// tests/Feature/ReviewTest.php
namespace Cartino\Reviews\Tests\Feature;

use Cartino\Reviews\Models\Review;
use Cartino\Models\Product;
use Cartino\Models\Customer;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class ReviewTest extends TestCase
{
    use RefreshDatabase;

    public function test_customer_can_create_review()
    {
        $customer = Customer::factory()->create();
        $product = Product::factory()->create();

        $this->actingAs($customer, 'customer')
            ->postJson('/api/reviews', [
                'product_id' => $product->id,
                'rating' => 5,
                'title' => 'Great product!',
                'body' => 'I really love this product. Highly recommended!',
            ])
            ->assertCreated();

        $this->assertDatabaseHas('reviews', [
            'product_id' => $product->id,
            'customer_id' => $customer->id,
            'rating' => 5,
        ]);
    }

    public function test_review_requires_approval_by_default()
    {
        $review = Review::factory()->create();

        $this->assertFalse($review->is_approved);
    }

    public function test_admin_can_approve_review()
    {
        $admin = User::factory()->admin()->create();
        $review = Review::factory()->create(['is_approved' => false]);

        $this->actingAs($admin)
            ->post("/admin/reviews/{$review->id}/approve")
            ->assertRedirect();

        $this->assertTrue($review->fresh()->is_approved);
    }

    public function test_approved_reviews_are_visible()
    {
        Review::factory()->approved()->count(3)->create();
        Review::factory()->pending()->count(2)->create();

        $response = $this->getJson('/api/reviews?filter[is_approved]=1');

        $response->assertJsonCount(3, 'data');
    }

    public function test_average_rating_is_calculated_correctly()
    {
        $product = Product::factory()->create();

        Review::factory()->create(['product_id' => $product->id, 'rating' => 5]);
        Review::factory()->create(['product_id' => $product->id, 'rating' => 4]);
        Review::factory()->create(['product_id' => $product->id, 'rating' => 3]);

        $average = $product->reviews()->avg('rating');

        $this->assertEquals(4.0, $average);
    }
}
```

## Extending Core Models

Add relationships to existing models:

```php
// In your ServiceProvider
use Cartino\Models\Product;
use Cartino\Reviews\Models\Review;

public function boot()
{
    // Add reviews relationship to Product
    Product::resolveRelationUsing('reviews', function ($product) {
        return $product->hasMany(Review::class);
    });

    // Add macro for average rating
    Product::macro('averageRating', function () {
        return $this->reviews()->approved()->avg('rating');
    });
}
```

Now products have reviews:

```php
$product = Product::find(1);

// Get all reviews
$reviews = $product->reviews;

// Get approved reviews only
$approvedReviews = $product->reviews()->approved()->get();

// Get average rating
$rating = $product->averageRating();
```

## Publishing Addon

### 1. Prepare Package

```bash
# Version tagging
git tag -a v1.0.0 -m "Release version 1.0.0"
git push origin v1.0.0
```

### 2. Submit to Packagist

1. Create account on [packagist.org](https://packagist.org)
2. Submit package URL
3. Enable auto-update webhook

### 3. Submit to Cartino Marketplace

```bash
# Create marketplace listing
php artisan cartino:addon:publish reviews

# Provide details:
# - Description
# - Screenshots
# - Demo URL
# - Documentation URL
# - Price (if premium)
```

## Resources

- [Statamic Addons Guide](https://statamic.dev/extending/addons)
- [Laravel Package Development](https://laravel.com/docs/packages)
- [Composer Documentation](https://getcomposer.org/doc/)

## Next Steps

- **[Admin Customization â†’](/developers/admin-customization)** - Customize admin UI
- **[Custom Fields â†’](/developers/custom-fields)** - Create field types
- **[Testing â†’](/developers/testing)** - Test your addon
