---


title: OrderItem
description: OrderItem model reference


---
# Model: OrderItem

The OrderItem model represents individual products in an order. Each item is a snapshot of the product at purchase time with pricing, quantity, and fulfillment tracking.

[TOC]

## Overview

An **OrderItem** is a line item in an order, capturing product details at the time of purchase:

```php
OrderItem {
    order_id: 456
    product_variant_id: 245
    quantity: 2
    price: 49.99
    compare_at_price: 59.99
    total: 99.98
    fulfillment_status: "unfulfilled"
    snapshot: {
        "product_name": "T-Shirt",
        "variant_name": "Blue / Large",
        "sku": "TSH-BLU-L"
    }
}
```

**Key Responsibilities**:
- Store product snapshot at purchase time
- Track fulfillment status per line item
- Handle partial refunds
- Calculate taxes per item
- Track inventory reservation

---

## Database Schema

```php
Schema::create('order_items', function (Blueprint $table) {
    $table->id();

    // Relationships
    $table->foreignId('order_id')->constrained()->cascadeOnDelete();
    $table->foreignId('product_variant_id')->nullable()->constrained()->nullOnDelete();

    // Product snapshot (in case product is deleted)
    $table->string('product_name');
    $table->string('variant_name')->nullable();
    $table->string('sku');
    $table->string('barcode')->nullable();

    // Quantity & Pricing
    $table->integer('quantity');
    $table->decimal('price', 15, 2);
    $table->decimal('compare_at_price', 15, 2)->nullable();
    $table->decimal('total', 15, 2);

    // Discounts & Tax
    $table->decimal('discount', 15, 2)->default(0);
    $table->foreignId('discount_id')->nullable()->constrained()->nullOnDelete();
    $table->decimal('tax', 15, 2)->default(0);
    $table->decimal('tax_rate', 5, 4)->default(0);

    // Physical properties
    $table->decimal('weight', 10, 2)->nullable();
    $table->boolean('requires_shipping')->default(true);

    // Fulfillment
    $table->string('fulfillment_status')->default('unfulfilled');
    $table->integer('quantity_fulfilled')->default(0);
    $table->integer('quantity_refunded')->default(0);
    $table->foreignId('shipment_id')->nullable()->constrained()->nullOnDelete();

    // Inventory
    $table->foreignId('inventory_reservation_id')->nullable();

    // Customization
    $table->json('snapshot')->nullable(); // Full product data at purchase
    $table->json('data')->nullable(); // Custom fields, gift options
    $table->text('notes')->nullable();

    $table->timestamps();

    // Indexes
    $table->index('order_id');
    $table->index('product_variant_id');
    $table->index('sku');
    $table->index('fulfillment_status');
});
```

---

## Properties

| Property | Type | Description |
|----------|------|-------------|
| `id` | `bigint` | Primary key |
| `order_id` | `bigint` | Order ID (FK) |
| `product_variant_id` | `bigint` | ProductVariant ID (FK, nullable) |
| `product_name` | `string` | Product name snapshot |
| `variant_name` | `string` | Variant name snapshot |
| `sku` | `string` | SKU snapshot |
| `barcode` | `string` | Barcode snapshot |
| `quantity` | `integer` | Quantity ordered |
| `price` | `decimal` | Unit price |
| `compare_at_price` | `decimal` | Compare at price |
| `total` | `decimal` | Line total |
| `discount` | `decimal` | Discount amount |
| `discount_id` | `bigint` | Applied discount (FK) |
| `tax` | `decimal` | Tax amount |
| `tax_rate` | `decimal` | Tax rate applied |
| `weight` | `decimal` | Unit weight |
| `requires_shipping` | `boolean` | Needs shipping |
| `fulfillment_status` | `string` | unfulfilled, partial, fulfilled, returned |
| `quantity_fulfilled` | `integer` | Fulfilled quantity |
| `quantity_refunded` | `integer` | Refunded quantity |
| `shipment_id` | `bigint` | Shipment ID (FK) |
| `inventory_reservation_id` | `bigint` | Inventory reservation |
| `snapshot` | `json` | Product data snapshot |
| `data` | `json` | Custom data |
| `notes` | `text` | Notes |

---

## Relationships

```php
namespace Shopper\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

class OrderItem extends Model
{
    protected $fillable = [
        'order_id',
        'product_variant_id',
        'product_name',
        'variant_name',
        'sku',
        'barcode',
        'quantity',
        'price',
        'compare_at_price',
        'total',
        'discount',
        'discount_id',
        'tax',
        'tax_rate',
        'weight',
        'requires_shipping',
        'fulfillment_status',
        'quantity_fulfilled',
        'quantity_refunded',
        'shipment_id',
        'inventory_reservation_id',
        'snapshot',
        'data',
        'notes',
    ];

    protected $casts = [
        'quantity' => 'integer',
        'price' => 'decimal:2',
        'compare_at_price' => 'decimal:2',
        'total' => 'decimal:2',
        'discount' => 'decimal:2',
        'tax' => 'decimal:2',
        'tax_rate' => 'decimal:4',
        'weight' => 'decimal:2',
        'requires_shipping' => 'boolean',
        'quantity_fulfilled' => 'integer',
        'quantity_refunded' => 'integer',
        'snapshot' => 'array',
        'data' => 'array',
    ];

    // Order
    public function order(): BelongsTo
    {
        return $this->belongsTo(Order::class);
    }

    // ProductVariant (can be null if deleted)
    public function variant(): BelongsTo
    {
        return $this->belongsTo(ProductVariant::class, 'product_variant_id');
    }

    // Discount
    public function discount(): BelongsTo
    {
        return $this->belongsTo(Discount::class);
    }

    // Shipment
    public function shipment(): BelongsTo
    {
        return $this->belongsTo(Shipment::class);
    }
}
```

---

## Accessors & Mutators

```php
// Display name
public function getDisplayNameAttribute(): string
{
    if ($this->variant_name) {
        return "{$this->product_name} - {$this->variant_name}";
    }

    return $this->product_name;
}

// Quantity pending fulfillment
public function getQuantityPendingAttribute(): int
{
    return $this->quantity - $this->quantity_fulfilled - $this->quantity_refunded;
}

// Can fulfill
public function getCanFulfillAttribute(): bool
{
    return $this->quantity_pending > 0;
}

// Is fulfilled
public function getIsFulfilledAttribute(): bool
{
    return $this->fulfillment_status === 'fulfilled';
}

// Subtotal (before tax)
public function getSubtotalAttribute(): float
{
    return $this->total - $this->tax;
}

// Total weight
public function getTotalWeightAttribute(): float
{
    return ($this->weight ?? 0) * $this->quantity;
}

// Grand total (with tax)
public function getGrandTotalAttribute(): float
{
    return $this->total + $this->tax;
}
```

---

## Methods

### Create from CartItem

```php
public static function createFromCartItem(CartItem $cartItem, Order $order): self
{
    $variant = $cartItem->variant;
    $product = $variant->product;

    return self::create([
        'order_id' => $order->id,
        'product_variant_id' => $variant->id,
        'product_name' => $product->name,
        'variant_name' => $variant->display_name,
        'sku' => $variant->sku,
        'barcode' => $variant->barcode,
        'quantity' => $cartItem->quantity,
        'price' => $cartItem->price,
        'compare_at_price' => $cartItem->compare_at_price,
        'total' => $cartItem->total,
        'discount' => $cartItem->discount,
        'discount_id' => $cartItem->discount_id,
        'weight' => $variant->weight,
        'requires_shipping' => $variant->requires_shipping,
        'snapshot' => [
            'product' => $product->toArray(),
            'variant' => $variant->toArray(),
        ],
        'data' => $cartItem->data,
        'notes' => $cartItem->notes,
    ]);
}
```

### Fulfill Item

```php
public function fulfill(int $quantity = null): void
{
    $quantity = $quantity ?? $this->quantity_pending;

    if ($quantity > $this->quantity_pending) {
        throw new \Exception('Cannot fulfill more than pending quantity');
    }

    $this->increment('quantity_fulfilled', $quantity);

    // Update fulfillment status
    if ($this->quantity_fulfilled >= $this->quantity) {
        $this->fulfillment_status = 'fulfilled';
    } elseif ($this->quantity_fulfilled > 0) {
        $this->fulfillment_status = 'partial';
    }

    $this->save();

    // Update order fulfillment status
    $this->order->updateFulfillmentStatus();

    // Reduce inventory
    if ($this->variant) {
        $this->variant->reduceInventory($quantity);
    }
}
```

### Refund Item

```php
public function refund(int $quantity, string $reason = null): Refund
{
    if ($quantity > $this->quantity_fulfilled) {
        throw new \Exception('Cannot refund more than fulfilled quantity');
    }

    $refundAmount = ($this->price * $quantity) + ($this->tax * $quantity / $this->quantity);

    $refund = $this->order->refunds()->create([
        'amount' => $refundAmount,
        'reason' => $reason,
        'items' => [
            [
                'order_item_id' => $this->id,
                'quantity' => $quantity,
                'amount' => $refundAmount,
            ],
        ],
    ]);

    $this->increment('quantity_refunded', $quantity);

    // Restore inventory
    if ($this->variant) {
        $this->variant->restoreInventory($quantity);
    }

    return $refund;
}
```

### Calculate Tax

```php
public function calculateTax(float $taxRate): void
{
    $this->tax_rate = $taxRate;
    $this->tax = $this->total * $taxRate;
    $this->save();
}
```

---

## Events

```php
use Shopper\Events\OrderItemFulfilled;
use Shopper\Events\OrderItemRefunded;

protected static function booted()
{
    static::updated(function (OrderItem $item) {
        if ($item->isDirty('quantity_fulfilled')) {
            event(new OrderItemFulfilled($item));
        }

        if ($item->isDirty('quantity_refunded')) {
            event(new OrderItemRefunded($item));
        }
    });
}
```

---

## REST API

### Get Order Items

```http
GET /api/v1/orders/{order}/items
```

**Response**:
```json
{
  "data": [
    {
      "id": 789,
      "product_variant_id": 245,
      "product_name": "T-Shirt",
      "variant_name": "Blue / Large",
      "sku": "TSH-BLU-L",
      "quantity": 2,
      "price": "49.99",
      "total": "99.98",
      "tax": "22.00",
      "fulfillment_status": "fulfilled",
      "quantity_fulfilled": 2,
      "quantity_pending": 0
    }
  ]
}
```

### Fulfill Item

```http
POST /api/v1/order-items/{item}/fulfill
```

**Request**:
```json
{
  "quantity": 2,
  "shipment_id": 15
}
```

### Refund Item

```http
POST /api/v1/order-items/{item}/refund
```

**Request**:
```json
{
  "quantity": 1,
  "reason": "Customer requested refund"
}
```

---

## GraphQL API

```graphql
query {
  order(id: 456) {
    items {
      id
      displayName
      sku
      quantity
      price
      total
      tax
      fulfillmentStatus
      quantityFulfilled
      quantityPending
      variant {
        id
        image {
          url
        }
      }
    }
  }
}
```

---

## Related Documentation

- [Order Model](model-order)
- [CartItem Model](model-cart-item)
- [ProductVariant Model](model-product-variant)
- [Shipment Model](model-shipment)
- [Refund Model](model-refund)
- [REST API - Orders](api-orders)
