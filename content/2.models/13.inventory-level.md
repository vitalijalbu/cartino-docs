---


title: InventoryLevel
description: InventoryLevel model reference


---
# Model: InventoryLevel

The InventoryLevel model tracks stock quantities for an InventoryItem at a specific Location. It enables multi-location inventory management with per-location availability.

[TOC]

## Overview

An **InventoryLevel** represents stock at a specific location:

```php
InventoryLevel {
    inventory_item_id: 1
    location_id: 5
    quantity: 50
    available_quantity: 35
    reserved_quantity: 15
}
```

**Multi-Location Inventory**:
- Warehouse A: 50 units
- Store NYC: 30 units
- Store LA: 20 units
- **Total**: 100 units

---

## Database Schema

```php
Schema::create('inventory_levels', function (Blueprint $table) {
    $table->id();

    // Relationships
    $table->foreignId('inventory_item_id')->constrained()->cascadeOnDelete();
    $table->foreignId('location_id')->constrained()->cascadeOnDelete();

    // Quantities
    $table->integer('quantity')->default(0);
    $table->integer('available_quantity')->default(0);
    $table->integer('reserved_quantity')->default(0);
    $table->integer('incoming_quantity')->default(0);

    // Settings per location
    $table->integer('reorder_point')->nullable();
    $table->integer('reorder_quantity')->nullable();
    $table->integer('max_quantity')->nullable();

    // Timestamps
    $table->timestamp('last_restocked_at')->nullable();
    $table->timestamps();

    // Unique constraint
    $table->unique(['inventory_item_id', 'location_id']);

    // Indexes
    $table->index('inventory_item_id');
    $table->index('location_id');
    $table->index('available_quantity');
});
```

---

## Properties

| Property | Type | Description |
|----------|------|-------------|
| `id` | `bigint` | Primary key |
| `inventory_item_id` | `bigint` | InventoryItem ID (FK) |
| `location_id` | `bigint` | Location ID (FK) |
| `quantity` | `integer` | Total quantity at location |
| `available_quantity` | `integer` | Available for sale |
| `reserved_quantity` | `integer` | Reserved for orders |
| `incoming_quantity` | `integer` | Expected stock |
| `reorder_point` | `integer` | Location-specific reorder point |
| `reorder_quantity` | `integer` | Location-specific reorder quantity |
| `max_quantity` | `integer` | Maximum capacity |
| `last_restocked_at` | `timestamp` | Last restock date |

---

## Relationships

```php
namespace Cartino\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\HasMany;

class InventoryLevel extends Model
{
    protected $fillable = [
        'inventory_item_id',
        'location_id',
        'quantity',
        'available_quantity',
        'reserved_quantity',
        'incoming_quantity',
        'reorder_point',
        'reorder_quantity',
        'max_quantity',
        'last_restocked_at',
    ];

    protected $casts = [
        'quantity' => 'integer',
        'available_quantity' => 'integer',
        'reserved_quantity' => 'integer',
        'incoming_quantity' => 'integer',
        'reorder_point' => 'integer',
        'reorder_quantity' => 'integer',
        'max_quantity' => 'integer',
        'last_restocked_at' => 'datetime',
    ];

    // InventoryItem
    public function inventoryItem(): BelongsTo
    {
        return $this->belongsTo(InventoryItem::class);
    }

    // Location
    public function location(): BelongsTo
    {
        return $this->belongsTo(Location::class);
    }

    // Stock movements at this location
    public function movements(): HasMany
    {
        return $this->hasMany(StockMovement::class);
    }
}
```

---

## Scopes

```php
// At location
public function scopeAtLocation($query, int $locationId)
{
    return $query->where('location_id', $locationId);
}

// Available
public function scopeAvailable($query, int $quantity = 1)
{
    return $query->where('available_quantity', '>=', $quantity);
}

// Low stock
public function scopeLowStock($query)
{
    return $query->whereColumn('available_quantity', '<=', 'reorder_point');
}

// Out of stock
public function scopeOutOfStock($query)
{
    return $query->where('available_quantity', '<=', 0);
}

// Over capacity
public function scopeOverCapacity($query)
{
    return $query->whereColumn('quantity', '>', 'max_quantity');
}
```

---

## Accessors & Mutators

```php
// Is available
public function getIsAvailableAttribute(): bool
{
    return $this->available_quantity > 0;
}

// Is low stock
public function getIsLowStockAttribute(): bool
{
    if (!$this->reorder_point) {
        return false;
    }

    return $this->available_quantity <= $this->reorder_point;
}

// Is out of stock
public function getIsOutOfStockAttribute(): bool
{
    return $this->available_quantity <= 0;
}

// Is over capacity
public function getIsOverCapacityAttribute(): bool
{
    if (!$this->max_quantity) {
        return false;
    }

    return $this->quantity > $this->max_quantity;
}

// Available capacity
public function getAvailableCapacityAttribute(): ?int
{
    if (!$this->max_quantity) {
        return null;
    }

    return max(0, $this->max_quantity - $this->quantity);
}
```

---

## Methods

### Adjust Quantity

```php
public function adjust(int $quantity, string $reason): void
{
    if ($quantity > 0) {
        $this->increment('quantity', $quantity);
        $this->increment('available_quantity', $quantity);
        $this->last_restocked_at = now();
    } else {
        $this->decrement('quantity', abs($quantity));
        $this->decrement('available_quantity', abs($quantity));
    }

    $this->save();

    // Record movement
    $this->movements()->create([
        'inventory_item_id' => $this->inventory_item_id,
        'type' => $quantity > 0 ? 'adjustment_in' : 'adjustment_out',
        'quantity' => $quantity,
        'reason' => $reason,
    ]);

    // Update parent inventory item
    $this->inventoryItem->recalculate();
}
```

### Reserve Stock

```php
public function reserve(int $quantity): void
{
    if ($this->available_quantity < $quantity) {
        throw new InsufficientStockException(
            "Only {$this->available_quantity} units available at {$this->location->name}"
        );
    }

    $this->decrement('available_quantity', $quantity);
    $this->increment('reserved_quantity', $quantity);

    // Record movement
    $this->movements()->create([
        'inventory_item_id' => $this->inventory_item_id,
        'type' => 'reservation',
        'quantity' => -$quantity,
        'reason' => 'Order reservation',
    ]);

    // Update parent
    $this->inventoryItem->recalculate();
}
```

### Release Stock

```php
public function release(int $quantity): void
{
    $releaseQty = min($quantity, $this->reserved_quantity);

    $this->increment('available_quantity', $releaseQty);
    $this->decrement('reserved_quantity', $releaseQty);

    // Record movement
    $this->movements()->create([
        'inventory_item_id' => $this->inventory_item_id,
        'type' => 'release',
        'quantity' => $releaseQty,
        'reason' => 'Reservation cancelled',
    ]);

    // Update parent
    $this->inventoryItem->recalculate();
}
```

### Fulfill Stock

```php
public function fulfill(int $quantity): void
{
    if ($this->reserved_quantity < $quantity) {
        throw new \Exception('Cannot fulfill more than reserved quantity');
    }

    $this->decrement('reserved_quantity', $quantity);
    $this->decrement('quantity', $quantity);

    // Record movement
    $this->movements()->create([
        'inventory_item_id' => $this->inventory_item_id,
        'type' => 'fulfillment',
        'quantity' => -$quantity,
        'reason' => 'Order fulfilled',
    ]);

    // Update parent
    $this->inventoryItem->recalculate();
}
```

### Transfer To Location

```php
public function transferTo(Location $targetLocation, int $quantity, string $reason = null): InventoryLevel
{
    if ($this->available_quantity < $quantity) {
        throw new InsufficientStockException(
            "Only {$this->available_quantity} units available for transfer"
        );
    }

    // Remove from source
    $this->adjust(-$quantity, $reason ?? "Transfer to {$targetLocation->name}");

    // Add to target
    $targetLevel = InventoryLevel::firstOrCreate([
        'inventory_item_id' => $this->inventory_item_id,
        'location_id' => $targetLocation->id,
    ]);

    $targetLevel->adjust($quantity, $reason ?? "Transfer from {$this->location->name}");

    return $targetLevel;
}
```

---

## Events

```php
use Cartino\Events\LocationLowStock;
use Cartino\Events\LocationOutOfStock;

protected static function booted()
{
    static::updated(function (InventoryLevel $level) {
        if ($level->isDirty('available_quantity')) {
            if ($level->is_low_stock && !$level->is_out_of_stock) {
                event(new LocationLowStock($level));
            }

            if ($level->is_out_of_stock) {
                event(new LocationOutOfStock($level));
            }
        }
    });
}
```

---

## REST API

### Get Inventory Levels

```http
GET /api/v1/inventory-items/{item}/levels
```

**Response**:
```json
{
  "data": [
    {
      "id": 1,
      "location_id": 5,
      "location": {
        "id": 5,
        "name": "Warehouse NYC",
        "code": "NYC-01"
      },
      "quantity": 50,
      "available_quantity": 35,
      "reserved_quantity": 15,
      "is_low_stock": true
    }
  ]
}
```

### Adjust Level

```http
POST /api/v1/inventory-levels/{level}/adjust
```

**Request**:
```json
{
  "quantity": 50,
  "reason": "Received from supplier"
}
```

### Transfer Stock

```http
POST /api/v1/inventory-levels/{level}/transfer
```

**Request**:
```json
{
  "target_location_id": 3,
  "quantity": 20,
  "reason": "Stock replenishment"
}
```

---

## GraphQL API

```graphql
query {
  inventoryItem(id: 1) {
    levels {
      id
      location {
        id
        name
        code
      }
      quantity
      availableQuantity
      reservedQuantity
      isLowStock
      isOutOfStock
    }
  }
}

mutation {
  adjustInventoryLevel(
    id: 1
    quantity: 50
    reason: "Received from supplier"
  ) {
    inventoryLevel {
      quantity
      availableQuantity
    }
  }
}
```

---

## Practical Examples

### Find Best Location for Order

```php
use Cartino\Models\InventoryItem;

$item = InventoryItem::find(1);
$requiredQty = 10;

// Find location with enough stock, prefer closest to customer
$level = $item->levels()
    ->available($requiredQty)
    ->orderByRaw("FIELD(location_id, {$customerPreferredLocationIds})")
    ->first();

if ($level) {
    $level->reserve($requiredQty);
}
```

### Rebalance Stock Across Locations

```php
$item = InventoryItem::find(1);

$levels = $item->levels()->get();
$avgStock = $levels->avg('quantity');

foreach ($levels as $level) {
    if ($level->quantity < $avgStock * 0.5) {
        // Find location with excess stock
        $sourceLevel = $levels
            ->where('quantity', '>', $avgStock * 1.5)
            ->first();

        if ($sourceLevel) {
            $transferQty = min(
                floor(($avgStock - $level->quantity) / 2),
                $sourceLevel->available_quantity
            );

            if ($transferQty > 0) {
                $sourceLevel->transferTo(
                    $level->location,
                    $transferQty,
                    'Rebalancing stock levels'
                );
            }
        }
    }
}
```

### Check Stock by Location

```php
$item = InventoryItem::where('sku', 'TSH-BLU-L')->first();

$stockByLocation = $item->levels()
    ->with('location')
    ->get()
    ->map(fn($level) => [
        'location' => $level->location->name,
        'available' => $level->available_quantity,
        'reserved' => $level->reserved_quantity,
        'status' => $level->is_low_stock ? 'Low' : 'OK',
    ]);
```

---

## Performance Tips

### 1. Eager Load Relationships

```php
$levels = InventoryLevel::with(['inventoryItem.variant', 'location'])
    ->lowStock()
    ->get();
```

### 2. Cache Location Stock

```php
use Illuminate\Support\Facades\Cache;

$stockAtLocation = Cache::remember(
    "location.{$locationId}.stock.{$itemId}",
    now()->addMinutes(5),
    fn() => InventoryLevel::where('inventory_item_id', $itemId)
        ->where('location_id', $locationId)
        ->first()
);
```

---

## Related Documentation

- [InventoryItem Model](model-inventory-item)
- [Location Model](model-location)
- [StockMovement Model](model-stock-movement)
- [Inventory Management Guide](inventory-management)
- [REST API - Inventory](api-inventory)
