---


title: Coupon
description: Coupon model reference


---
# Model: Coupon

The Coupon model manages promotional codes that customers can enter at checkout. Unlike automatic Discounts, Coupons require a code to be applied manually.

[TOC]

## Overview

A **Coupon** is a code-based discount:

```php
Coupon {
    code: "SUMMER20"
    name: "Summer Sale 20% Off"
    type: "percentage"
    value: 20.00
    status: "active"
    usage_limit: 1000
    times_used: 247
    starts_at: "2025-06-01"
    ends_at: "2025-08-31"
}
```

**Coupon vs Discount**:
- **Coupon**: Requires code entry (SUMMER20, FREESHIP)
- **Discount**: Applied automatically

---

## Database Schema

```php
Schema::create('coupons', function (Blueprint $table) {
    $table->id();

    // Code
    $table->string('code')->unique(); // SUMMER20, WELCOME10
    $table->string('name');
    $table->text('description')->nullable();

    // Type & Value
    $table->string('type'); // percentage, fixed_amount, free_shipping, buy_x_get_y
    $table->decimal('value', 15, 2)->default(0);
    $table->integer('applies_to_quantity')->default(1); // For buy_x_get_y

    // Scope
    $table->string('applies_to')->default('cart'); // cart, products, categories, collections, shipping
    $table->json('applies_to_ids')->nullable();

    // Context
    $table->json('site_ids')->nullable();
    $table->json('channel_ids')->nullable();
    $table->json('customer_group_ids')->nullable();
    $table->json('customer_ids')->nullable(); // Specific customers only

    // Conditions
    $table->json('conditions')->nullable();
    /*
    {
        "min_purchase_amount": 50.00,
        "min_quantity": 2,
        "product_ids": [1, 2, 3],
        "category_ids": [5],
        "exclude_sale_items": true,
        "first_order_only": true
    }
    */

    // Limits
    $table->integer('usage_limit')->nullable(); // Total uses
    $table->integer('usage_limit_per_customer')->default(1);
    $table->integer('times_used')->default(0);

    // Schedule
    $table->timestamp('starts_at')->nullable();
    $table->timestamp('ends_at')->nullable();

    // Status
    $table->string('status')->default('active'); // draft, active, scheduled, expired, disabled

    // Meta
    $table->string('source')->nullable(); // email_campaign, influencer, affiliate
    $table->foreignId('created_by')->nullable(); // Admin user who created it

    $table->timestamps();
    $table->softDeletes();

    // Indexes
    $table->index('code');
    $table->index('status');
    $table->index(['starts_at', 'ends_at']);
    $table->index('created_by');
});
```

---

## Properties

| Property | Type | Description |
|----------|------|-------------|
| `id` | `bigint` | Primary key |
| `code` | `string` | Coupon code (unique) |
| `name` | `string` | Coupon name |
| `description` | `text` | Description |
| `type` | `string` | Discount type |
| `value` | `decimal` | Discount value |
| `applies_to_quantity` | `integer` | Buy X Get Y quantity |
| `applies_to` | `string` | What coupon applies to |
| `applies_to_ids` | `json` | Specific IDs |
| `site_ids` | `json` | Applicable sites |
| `channel_ids` | `json` | Applicable channels |
| `customer_group_ids` | `json` | Applicable customer groups |
| `customer_ids` | `json` | Specific customers only |
| `conditions` | `json` | Conditions to apply |
| `usage_limit` | `integer` | Total usage limit |
| `usage_limit_per_customer` | `integer` | Per-customer limit |
| `times_used` | `integer` | Times used |
| `starts_at` | `timestamp` | Start date |
| `ends_at` | `timestamp` | End date |
| `status` | `string` | Status |
| `source` | `string` | Source/campaign |
| `created_by` | `bigint` | Creator user ID |

---

## Relationships

```php
namespace Shopper\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\SoftDeletes;

class Coupon extends Model
{
    use SoftDeletes;

    protected $fillable = [
        'code',
        'name',
        'description',
        'type',
        'value',
        'applies_to_quantity',
        'applies_to',
        'applies_to_ids',
        'site_ids',
        'channel_ids',
        'customer_group_ids',
        'customer_ids',
        'conditions',
        'usage_limit',
        'usage_limit_per_customer',
        'times_used',
        'starts_at',
        'ends_at',
        'status',
        'source',
        'created_by',
    ];

    protected $casts = [
        'value' => 'decimal:2',
        'applies_to_quantity' => 'integer',
        'applies_to_ids' => 'array',
        'site_ids' => 'array',
        'channel_ids' => 'array',
        'customer_group_ids' => 'array',
        'customer_ids' => 'array',
        'conditions' => 'array',
        'usage_limit' => 'integer',
        'usage_limit_per_customer' => 'integer',
        'times_used' => 'integer',
        'starts_at' => 'datetime',
        'ends_at' => 'datetime',
    ];

    // Usage records
    public function usages(): HasMany
    {
        return $this->hasMany(CouponUsage::class);
    }

    // Creator
    public function creator(): BelongsTo
    {
        return $this->belongsTo(User::class, 'created_by');
    }
}
```

---

## Scopes

```php
// Active coupons
public function scopeActive($query)
{
    return $query->where('status', 'active')
        ->where(function ($q) {
            $q->whereNull('starts_at')
              ->orWhere('starts_at', '<=', now());
        })
        ->where(function ($q) {
            $q->whereNull('ends_at')
              ->orWhere('ends_at', '>=', now());
        })
        ->where(function ($q) {
            $q->whereNull('usage_limit')
              ->orWhereRaw('times_used < usage_limit');
        });
}

// By code
public function scopeByCode($query, string $code)
{
    return $query->where('code', strtoupper($code));
}

// For site
public function scopeForSite($query, int $siteId)
{
    return $query->where(function ($q) use ($siteId) {
        $q->whereNull('site_ids')
          ->orWhereJsonContains('site_ids', $siteId);
    });
}

// For customer
public function scopeForCustomer($query, int $customerId, ?int $customerGroupId = null)
{
    return $query->where(function ($q) use ($customerId, $customerGroupId) {
        // Check specific customer IDs
        $q->whereNull('customer_ids')
          ->orWhereJsonContains('customer_ids', $customerId);
    })
    ->where(function ($q) use ($customerGroupId) {
        // Check customer groups
        $q->whereNull('customer_group_ids')
          ->orWhen($customerGroupId, fn($q) =>
              $q->whereJsonContains('customer_group_ids', $customerGroupId)
          );
    });
}
```

---

## Accessors & Mutators

```php
// Uppercase code
public function setCodeAttribute($value)
{
    $this->attributes['code'] = strtoupper($value);
}

// Is currently active
public function getIsActiveAttribute(): bool
{
    if ($this->status !== 'active') {
        return false;
    }

    $now = now();

    if ($this->starts_at && $this->starts_at > $now) {
        return false;
    }

    if ($this->ends_at && $this->ends_at < $now) {
        return false;
    }

    if ($this->usage_limit && $this->times_used >= $this->usage_limit) {
        return false;
    }

    return true;
}

// Formatted value
public function getFormattedValueAttribute(): string
{
    return match($this->type) {
        'percentage' => "{$this->value}% off",
        'fixed_amount' => money($this->value) . " off",
        'free_shipping' => 'Free Shipping',
        'buy_x_get_y' => "Buy {$this->applies_to_quantity} Get 1 Free",
        default => (string) $this->value,
    };
}

// Usage remaining
public function getUsageRemainingAttribute(): ?int
{
    if (!$this->usage_limit) {
        return null;
    }

    return max(0, $this->usage_limit - $this->times_used);
}

// Usage percentage
public function getUsagePercentageAttribute(): ?float
{
    if (!$this->usage_limit) {
        return null;
    }

    return round(($this->times_used / $this->usage_limit) * 100, 2);
}
```

---

## Methods

### Validate Code

```php
public static function validateCode(
    string $code,
    Cart $cart,
    ?Customer $customer = null
): array
{
    $coupon = self::byCode($code)
        ->active()
        ->forSite($cart->site_id)
        ->first();

    if (!$coupon) {
        return [
            'valid' => false,
            'error' => 'Invalid or expired coupon code',
        ];
    }

    // Check if customer can use it
    if ($customer && !$coupon->canBeUsedBy($customer)) {
        return [
            'valid' => false,
            'error' => 'This coupon is not available for your account',
        ];
    }

    // Check conditions
    if (!$coupon->checkConditions($cart, $customer)) {
        $minAmount = $coupon->conditions['min_purchase_amount'] ?? null;
        if ($minAmount) {
            return [
                'valid' => false,
                'error' => "Minimum purchase amount: " . money($minAmount),
            ];
        }

        return [
            'valid' => false,
            'error' => 'Coupon conditions not met',
        ];
    }

    return [
        'valid' => true,
        'coupon' => $coupon,
        'discount_amount' => $coupon->calculateFor($cart),
    ];
}
```

### Check if Customer Can Use

```php
public function canBeUsedBy(Customer $customer): bool
{
    // Check specific customer IDs
    if ($this->customer_ids && !in_array($customer->id, $this->customer_ids)) {
        return false;
    }

    // Check customer groups
    if ($this->customer_group_ids && !in_array($customer->customer_group_id, $this->customer_group_ids)) {
        return false;
    }

    // Check usage limit per customer
    if ($this->usage_limit_per_customer) {
        $customerUsage = $this->usages()
            ->where('customer_id', $customer->id)
            ->count();

        if ($customerUsage >= $this->usage_limit_per_customer) {
            return false;
        }
    }

    return true;
}
```

### Check Conditions

```php
public function checkConditions(Cart $cart, ?Customer $customer = null): bool
{
    if (!$this->conditions) {
        return true;
    }

    // Min purchase amount
    if (isset($this->conditions['min_purchase_amount'])) {
        if ($cart->subtotal < $this->conditions['min_purchase_amount']) {
            return false;
        }
    }

    // First order only
    if ($this->conditions['first_order_only'] ?? false) {
        if ($customer && $customer->orders()->where('status', 'completed')->exists()) {
            return false;
        }
    }

    // Same checks as Discount model...
    return true;
}
```

### Calculate Discount

```php
public function calculateFor(Cart $cart): float
{
    // Same implementation as Discount model
    return match($this->type) {
        'percentage' => $this->calculatePercentage($cart),
        'fixed_amount' => min($this->value, $cart->subtotal),
        'buy_x_get_y' => $this->calculateBuyXGetY($cart),
        'free_shipping' => $cart->shipping,
        default => 0,
    };
}
```

### Apply to Cart

```php
public function applyTo(Cart $cart, ?Customer $customer = null): bool
{
    // Validate
    $validation = self::validateCode($this->code, $cart, $customer);

    if (!$validation['valid']) {
        return false;
    }

    $amount = $this->calculateFor($cart);

    $cart->update([
        'coupon_id' => $this->id,
        'coupon_code' => $this->code,
        'discount' => $amount,
    ]);

    // Record usage
    $this->increment('times_used');

    $this->usages()->create([
        'cart_id' => $cart->id,
        'order_id' => null,
        'customer_id' => $customer?->id,
        'discount_amount' => $amount,
    ]);

    return true;
}
```

### Generate Unique Code

```php
public static function generateCode(int $length = 8): string
{
    do {
        $code = strtoupper(Str::random($length));
    } while (self::where('code', $code)->exists());

    return $code;
}
```

---

## Events

```php
use Shopper\Events\CouponApplied;
use Shopper\Events\CouponUsageLimitReached;

protected static function booted()
{
    static::updated(function (Coupon $coupon) {
        // Check if usage limit reached
        if ($coupon->usage_limit && $coupon->times_used >= $coupon->usage_limit) {
            $coupon->update(['status' => 'expired']);
            event(new CouponUsageLimitReached($coupon));
        }
    });
}
```

---

## REST API

### Validate Coupon

```http
POST /api/v1/coupons/validate
```

**Request**:
```json
{
  "code": "SUMMER20",
  "cart_id": 15
}
```

**Response**:
```json
{
  "valid": true,
  "coupon": {
    "id": 10,
    "code": "SUMMER20",
    "name": "Summer Sale 20% Off",
    "formatted_value": "20% off",
    "discount_amount": "19.98"
  }
}
```

### Apply Coupon

```http
POST /api/v1/carts/{cart}/coupons
```

**Request**:
```json
{
  "code": "SUMMER20"
}
```

**Response**:
```json
{
  "message": "Coupon applied successfully",
  "discount": "19.98",
  "cart": {
    "subtotal": "99.90",
    "discount": "19.98",
    "total": "79.92"
  }
}
```

### Remove Coupon

```http
DELETE /api/v1/carts/{cart}/coupons
```

---

## GraphQL API

```graphql
mutation {
  validateCoupon(code: "SUMMER20", cartId: 15) {
    valid
    error
    coupon {
      code
      name
      formattedValue
      discountAmount
    }
  }
}

mutation {
  applyCoupon(cartId: 15, code: "SUMMER20") {
    success
    cart {
      subtotal
      discount
      total
      coupon {
        code
        name
      }
    }
  }
}
```

---

## Practical Examples

### Create Welcome Coupon

```php
use Shopper\Models\Coupon;

$coupon = Coupon::create([
    'code' => 'WELCOME10',
    'name' => 'Welcome 10% Off',
    'description' => 'First order discount',
    'type' => 'percentage',
    'value' => 10,
    'applies_to' => 'cart',
    'usage_limit_per_customer' => 1,
    'conditions' => [
        'first_order_only' => true,
        'min_purchase_amount' => 50.00,
    ],
    'status' => 'active',
]);
```

### Create Free Shipping Coupon

```php
$coupon = Coupon::create([
    'code' => 'FREESHIP',
    'name' => 'Free Shipping',
    'type' => 'free_shipping',
    'applies_to' => 'shipping',
    'conditions' => [
        'min_purchase_amount' => 100.00,
    ],
    'usage_limit' => 1000,
    'status' => 'active',
]);
```

### Create Influencer Coupon

```php
$coupon = Coupon::create([
    'code' => 'INFLUENCER20',
    'name' => 'Influencer 20% Off',
    'type' => 'percentage',
    'value' => 20,
    'source' => 'influencer_john',
    'usage_limit' => 500,
    'usage_limit_per_customer' => 1,
    'status' => 'active',
]);
```

### Generate Unique Coupons

```php
// Generate 100 unique coupons for email campaign
$coupons = [];

for ($i = 0; $i < 100; $i++) {
    $coupons[] = Coupon::create([
        'code' => Coupon::generateCode(),
        'name' => 'Email Campaign 15%',
        'type' => 'percentage',
        'value' => 15,
        'source' => 'email_campaign_2025_summer',
        'usage_limit' => 1,
        'usage_limit_per_customer' => 1,
        'status' => 'active',
    ]);
}
```

### Apply Coupon to Cart

```php
use Shopper\Models\Cart;
use Shopper\Models\Coupon;

$cart = Cart::find(15);
$customer = auth()->user()->customer;

$validation = Coupon::validateCode('SUMMER20', $cart, $customer);

if ($validation['valid']) {
    $validation['coupon']->applyTo($cart, $customer);

    return response()->json([
        'message' => 'Coupon applied!',
        'discount' => $validation['discount_amount'],
        'new_total' => $cart->fresh()->total,
    ]);
} else {
    return response()->json([
        'error' => $validation['error'],
    ], 400);
}
```

---

## Performance Tips

### 1. Cache Coupon Lookups

```php
use Illuminate\Support\Facades\Cache;

$coupon = Cache::remember(
    "coupon.{$code}",
    now()->addHours(1),
    fn() => Coupon::byCode($code)->active()->first()
);
```

### 2. Index Code Column

```sql
CREATE INDEX idx_coupons_code_status
ON coupons(code, status);
```

---

## Related Documentation

- [Discount Model](model-discount)
- [Cart Model](model-cart)
- [Discounts & Coupons Guide](discounts-coupons)
- [REST API - Discounts](api-discounts)
