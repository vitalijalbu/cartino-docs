# Spatie Query Builder

Cartino uses **[Spatie Laravel Query Builder](https://spatie.be/docs/laravel-query-builder)** to provide powerful, flexible API filtering, sorting, and field selection for all resources.

## Introduction

Query Builder allows API consumers to:
- ðŸ” **Filter** resources with complex conditions
- ðŸ“Š **Sort** results by multiple fields
- ðŸ“¦ **Include** related models (eager loading)
- ðŸŽ¯ **Select** specific fields to reduce payload
- ðŸ“„ **Paginate** results efficiently
- ðŸ”— **Append** computed attributes

## Installation

Query Builder is pre-installed with Cartino. If needed:

```bash
composer require spatie/laravel-query-builder
```

## Basic Usage

### Simple Query Builder

```php
use Spatie\QueryBuilder\QueryBuilder;

// In controller
public function index(Request $request)
{
    $products = QueryBuilder::for(Product::class)
        ->allowedFilters(['name', 'price'])
        ->allowedSorts(['name', 'created_at'])
        ->get();

    return response()->json($products);
}
```

### API Request Examples

```bash
# Filter by name
GET /api/products?filter[name]=T-Shirt

# Sort by price descending
GET /api/products?sort=-price

# Multiple filters
GET /api/products?filter[category]=clothing&filter[price]=2999

# Include relationships
GET /api/products?include=variants,category

# Select specific fields
GET /api/products?fields[products]=name,price,slug
```

## Filtering

### Allowed Filters

Define which fields can be filtered:

```php
QueryBuilder::for(Product::class)
    ->allowedFilters([
        'name',
        'slug',
        'price',
        'is_active',
    ])
    ->get();
```

Request:

```bash
GET /api/products?filter[name]=Shirt&filter[is_active]=1
```

### Exact vs Partial Filters

```php
use Spatie\QueryBuilder\AllowedFilter;

QueryBuilder::for(Product::class)
    ->allowedFilters([
        // Exact match (default)
        'price',

        // Partial match (LIKE)
        AllowedFilter::partial('name'),

        // Exact match (explicit)
        AllowedFilter::exact('sku'),
    ])
    ->get();
```

Request:

```bash
# Partial match: finds "T-Shirt", "Shirt", "Blue Shirt"
GET /api/products?filter[name]=shirt

# Exact match
GET /api/products?filter[price]=2999
```

### Scope Filters

Use model scopes as filters:

```php
// Product model
public function scopeActive($query)
{
    return $query->where('is_active', true);
}

public function scopePriceRange($query, $min, $max)
{
    return $query->whereBetween('price', [$min, $max]);
}
```

```php
// Controller
QueryBuilder::for(Product::class)
    ->allowedFilters([
        AllowedFilter::scope('active'),
        AllowedFilter::scope('price_range'),
    ])
    ->get();
```

Request:

```bash
GET /api/products?filter[active]=1
GET /api/products?filter[price_range]=1000,5000
```

### Custom Filters

Create custom filter classes:

```bash
php artisan make:filter ProductCategoryFilter
```

```php
namespace App\Filters;

use Illuminate\Database\Eloquent\Builder;
use Spatie\QueryBuilder\Filters\Filter;

class ProductCategoryFilter implements Filter
{
    public function __invoke(Builder $query, $value, string $property)
    {
        $query->whereHas('category', function ($query) use ($value) {
            $query->where('slug', $value);
        });
    }
}
```

Use in controller:

```php
use App\Filters\ProductCategoryFilter;

QueryBuilder::for(Product::class)
    ->allowedFilters([
        AllowedFilter::custom('category', new ProductCategoryFilter),
    ])
    ->get();
```

Request:

```bash
GET /api/products?filter[category]=clothing
```

### Relationship Filters

Filter by related model fields:

```php
use Spatie\QueryBuilder\AllowedFilter;

QueryBuilder::for(Product::class)
    ->allowedFilters([
        'name',
        AllowedFilter::exact('category.slug'), // Filter by category slug
        AllowedFilter::partial('variants.sku'), // Filter by variant SKU
    ])
    ->get();
```

Request:

```bash
GET /api/products?filter[category.slug]=clothing
GET /api/products?filter[variants.sku]=TSH-001
```

### Multiple Value Filters

Filter by multiple values:

```php
QueryBuilder::for(Product::class)
    ->allowedFilters([
        AllowedFilter::exact('id'),
    ])
    ->get();
```

Request (comma-separated):

```bash
GET /api/products?filter[id]=1,2,3,4,5
```

Generates: `WHERE id IN (1,2,3,4,5)`

### Comparison Filters

Use comparison operators:

```php
use Spatie\QueryBuilder\Filters\FiltersExact;

class PriceFilter extends FiltersExact
{
    public function __invoke(Builder $query, $value, string $property)
    {
        // Support operators: gt, gte, lt, lte
        if (isset($value['gt'])) {
            $query->where($property, '>', $value['gt']);
        }
        if (isset($value['gte'])) {
            $query->where($property, '>=', $value['gte']);
        }
        if (isset($value['lt'])) {
            $query->where($property, '<', $value['lt']);
        }
        if (isset($value['lte'])) {
            $query->where($property, '<=', $value['lte']);
        }
    }
}
```

```php
QueryBuilder::for(Product::class)
    ->allowedFilters([
        AllowedFilter::custom('price', new PriceFilter),
    ])
    ->get();
```

Request:

```bash
GET /api/products?filter[price][gte]=1000&filter[price][lte]=5000
```

### Date Filters

```php
use Spatie\QueryBuilder\AllowedFilter;

QueryBuilder::for(Order::class)
    ->allowedFilters([
        AllowedFilter::scope('created_after'),
        AllowedFilter::scope('created_before'),
    ])
    ->get();
```

```php
// Order model
public function scopeCreatedAfter($query, $date)
{
    return $query->where('created_at', '>=', $date);
}

public function scopeCreatedBefore($query, $date)
{
    return $query->where('created_at', '<=', $date);
}
```

Request:

```bash
GET /api/orders?filter[created_after]=2025-01-01&filter[created_before]=2025-12-31
```

## Sorting

### Allowed Sorts

```php
QueryBuilder::for(Product::class)
    ->allowedSorts(['name', 'price', 'created_at'])
    ->get();
```

Request:

```bash
# Ascending
GET /api/products?sort=price

# Descending (prefix with -)
GET /api/products?sort=-price

# Multiple sorts
GET /api/products?sort=category,-price,name
```

### Default Sort

```php
QueryBuilder::for(Product::class)
    ->allowedSorts(['name', 'price'])
    ->defaultSort('-created_at') // Default to newest first
    ->get();
```

### Custom Sorts

```php
use Spatie\QueryBuilder\AllowedSort;

QueryBuilder::for(Product::class)
    ->allowedSorts([
        'name',
        'price',
        AllowedSort::custom('popularity', new PopularitySort),
    ])
    ->get();
```

```php
namespace App\Sorts;

use Illuminate\Database\Eloquent\Builder;
use Spatie\QueryBuilder\Sorts\Sort;

class PopularitySort implements Sort
{
    public function __invoke(Builder $query, bool $descending, string $property)
    {
        $direction = $descending ? 'desc' : 'asc';

        $query->withCount('orders')
            ->orderBy('orders_count', $direction);
    }
}
```

Request:

```bash
GET /api/products?sort=-popularity
```

### Relationship Sorts

```php
use Spatie\QueryBuilder\AllowedSort;

QueryBuilder::for(Product::class)
    ->allowedSorts([
        'name',
        AllowedSort::field('category_name', 'category.name'),
    ])
    ->get();
```

Request:

```bash
GET /api/products?sort=category_name
```

## Includes (Eager Loading)

### Allowed Includes

```php
QueryBuilder::for(Product::class)
    ->allowedIncludes(['category', 'variants', 'images'])
    ->get();
```

Request:

```bash
# Include single relationship
GET /api/products?include=category

# Include multiple relationships
GET /api/products?include=category,variants,images

# Include nested relationships
GET /api/products?include=variants.prices
```

### Conditional Includes

```php
use Spatie\QueryBuilder\AllowedInclude;

QueryBuilder::for(Product::class)
    ->allowedIncludes([
        'category',
        AllowedInclude::relationship('variants', Product::class)
            ->where('is_active', true),
    ])
    ->get();
```

### Count Includes

Include relationship counts:

```php
QueryBuilder::for(Product::class)
    ->allowedIncludes([
        'variants',
    ])
    ->allowedCounts([
        'variants',
        'orders',
    ])
    ->get();
```

Request:

```bash
GET /api/products?include=variantsCount,ordersCount
```

Response includes `variants_count` and `orders_count` fields.

## Field Selection

### Select Specific Fields

Reduce payload size by selecting only needed fields:

```php
QueryBuilder::for(Product::class)
    ->allowedFields(['name', 'price', 'slug'])
    ->get();
```

Request:

```bash
GET /api/products?fields[products]=name,price,slug
```

### Fields for Relationships

```php
QueryBuilder::for(Product::class)
    ->allowedFields([
        'products.name',
        'products.price',
        'category.name',
        'category.slug',
    ])
    ->allowedIncludes(['category'])
    ->get();
```

Request:

```bash
GET /api/products?include=category&fields[products]=name,price&fields[category]=name,slug
```

## Appends (Computed Attributes)

### Allowed Appends

```php
QueryBuilder::for(Product::class)
    ->allowedAppends(['formatted_price', 'thumbnail_url'])
    ->get();
```

```php
// Product model
protected $appends = [];

public function getFormattedPriceAttribute()
{
    return money($this->price);
}

public function getThumbnailUrlAttribute()
{
    return $this->getFirstMediaUrl('images', 'thumb');
}
```

Request:

```bash
GET /api/products?append=formatted_price,thumbnail_url
```

## Complete Example

### Controller

```php
namespace App\Http\Controllers\Api;

use App\Models\Product;
use Spatie\QueryBuilder\QueryBuilder;
use Spatie\QueryBuilder\AllowedFilter;
use Spatie\QueryBuilder\AllowedSort;

class ProductController extends Controller
{
    public function index()
    {
        $products = QueryBuilder::for(Product::class)
            // Filtering
            ->allowedFilters([
                'name',
                'slug',
                'sku',
                AllowedFilter::partial('description'),
                AllowedFilter::exact('category_id'),
                AllowedFilter::scope('active'),
                AllowedFilter::scope('price_range'),
                AllowedFilter::custom('category', new CategoryFilter),
            ])
            // Sorting
            ->allowedSorts([
                'name',
                'price',
                'created_at',
                AllowedSort::custom('popularity', new PopularitySort),
            ])
            ->defaultSort('-created_at')
            // Includes
            ->allowedIncludes([
                'category',
                'variants',
                'variants.prices',
                'images',
            ])
            // Counts
            ->allowedCounts([
                'variants',
                'orders',
            ])
            // Fields
            ->allowedFields([
                'products.id',
                'products.name',
                'products.slug',
                'products.price',
                'products.description',
                'category.name',
                'category.slug',
            ])
            // Appends
            ->allowedAppends([
                'formatted_price',
                'thumbnail_url',
                'in_stock',
            ])
            // Pagination
            ->paginate(20)
            ->appends(request()->query());

        return response()->json($products);
    }
}
```

### API Requests

```bash
# Simple filter
GET /api/products?filter[name]=shirt

# Multiple filters
GET /api/products?filter[category]=clothing&filter[active]=1

# Price range
GET /api/products?filter[price_range]=1000,5000

# Sort
GET /api/products?sort=-price,name

# Include relationships
GET /api/products?include=category,variants

# Select fields
GET /api/products?fields[products]=name,price&fields[category]=name

# Append computed attributes
GET /api/products?append=formatted_price,thumbnail_url

# Combined query
GET /api/products?filter[category]=clothing&filter[active]=1&sort=-price&include=category,variants&fields[products]=name,price&append=thumbnail_url&page=1
```

## Cartino Built-in Filters

### Product Filters

```php
// app/Filters/ProductFilters.php
AllowedFilter::partial('name'),
AllowedFilter::exact('sku'),
AllowedFilter::exact('category_id'),
AllowedFilter::scope('active'),
AllowedFilter::scope('in_stock'),
AllowedFilter::scope('price_range'),
AllowedFilter::custom('category', new CategoryFilter),
AllowedFilter::custom('tag', new TagFilter),
```

### Order Filters

```php
// app/Filters/OrderFilters.php
AllowedFilter::exact('number'),
AllowedFilter::exact('status'),
AllowedFilter::exact('customer_id'),
AllowedFilter::scope('created_after'),
AllowedFilter::scope('created_before'),
AllowedFilter::scope('total_range'),
```

### Customer Filters

```php
// app/Filters/CustomerFilters.php
AllowedFilter::partial('name'),
AllowedFilter::partial('email'),
AllowedFilter::exact('customer_group_id'),
AllowedFilter::scope('vip'),
AllowedFilter::scope('has_orders'),
```

## Performance Optimization

### Eager Loading

Always eager load relationships to avoid N+1:

```php
QueryBuilder::for(Product::class)
    ->allowedIncludes(['category', 'variants'])
    ->get();
```

### Select Only Needed Fields

Reduce query size:

```php
QueryBuilder::for(Product::class)
    ->allowedFields(['name', 'price'])
    ->select(['id', 'name', 'price']) // Only select needed columns
    ->get();
```

### Index Database Columns

Ensure filtered/sorted columns are indexed:

```php
Schema::table('products', function (Blueprint $table) {
    $table->index('category_id');
    $table->index('price');
    $table->index('is_active');
    $table->index('created_at');
});
```

### Cache Results

```php
use Illuminate\Support\Facades\Cache;

$cacheKey = 'products:' . md5(request()->fullUrl());

$products = Cache::remember($cacheKey, 300, function () {
    return QueryBuilder::for(Product::class)
        ->allowedFilters(['name', 'category_id'])
        ->allowedSorts(['name', 'price'])
        ->paginate(20);
});
```

## API Documentation

### Document Query Parameters

```yaml
# OpenAPI/Swagger documentation
/api/products:
  get:
    summary: List products
    parameters:
      - name: filter[name]
        in: query
        description: Filter by product name (partial match)
        schema:
          type: string
      - name: filter[category_id]
        in: query
        description: Filter by category ID
        schema:
          type: integer
      - name: sort
        in: query
        description: Sort by field (prefix with - for descending)
        schema:
          type: string
          example: -price,name
      - name: include
        in: query
        description: Include relationships
        schema:
          type: string
          example: category,variants
      - name: page
        in: query
        description: Page number
        schema:
          type: integer
```

## Testing

### Test Filters

```php
test('products can be filtered by name', function () {
    $product1 = Product::factory()->create(['name' => 'Blue Shirt']);
    $product2 = Product::factory()->create(['name' => 'Red Pants']);

    $response = $this->getJson('/api/products?filter[name]=shirt');

    $response->assertOk()
        ->assertJsonCount(1, 'data')
        ->assertJsonPath('data.0.name', 'Blue Shirt');
});
```

### Test Sorts

```php
test('products can be sorted by price', function () {
    Product::factory()->create(['name' => 'Expensive', 'price' => 10000]);
    Product::factory()->create(['name' => 'Cheap', 'price' => 1000]);

    $response = $this->getJson('/api/products?sort=price');

    $response->assertOk()
        ->assertJsonPath('data.0.name', 'Cheap')
        ->assertJsonPath('data.1.name', 'Expensive');
});
```

### Test Includes

```php
test('products can include category', function () {
    $category = Category::factory()->create();
    $product = Product::factory()->create(['category_id' => $category->id]);

    $response = $this->getJson('/api/products?include=category');

    $response->assertOk()
        ->assertJsonStructure([
            'data' => [
                '*' => ['id', 'name', 'category'],
            ],
        ]);
});
```

## Common Patterns

### Search Query

```php
use Spatie\QueryBuilder\AllowedFilter;

QueryBuilder::for(Product::class)
    ->allowedFilters([
        AllowedFilter::callback('search', function ($query, $value) {
            $query->where('name', 'like', "%{$value}%")
                  ->orWhere('description', 'like', "%{$value}%")
                  ->orWhere('sku', 'like', "%{$value}%");
        }),
    ])
    ->get();
```

Request:

```bash
GET /api/products?filter[search]=blue shirt
```

### JSON Column Filtering

For JSON fields (like `fields` column):

```php
AllowedFilter::callback('color', function ($query, $value) {
    $query->whereJsonContains('fields->color', $value);
}),
```

Request:

```bash
GET /api/products?filter[color]=blue
```

### Boolean Filters

```php
AllowedFilter::callback('is_active', function ($query, $value) {
    $query->where('is_active', filter_var($value, FILTER_VALIDATE_BOOLEAN));
}),
```

Request:

```bash
GET /api/products?filter[is_active]=true
GET /api/products?filter[is_active]=1
```

## Troubleshooting

### Filter Not Working

Check allowed filters:

```php
// Ensure filter is allowed
->allowedFilters(['name', 'price'])
```

Ensure column exists in database.

### Include Not Working

Check relationship exists:

```php
// In Product model
public function category()
{
    return $this->belongsTo(Category::class);
}
```

### Performance Issues

- Add database indexes
- Eager load relationships
- Limit pagination size
- Cache results

## Best Practices

### 1. Always Whitelist Filters

```php
// âœ… Good: Explicit allowed filters
->allowedFilters(['name', 'price'])

// âŒ Bad: Allow all filters (security risk)
// Don't do this
```

### 2. Use Scopes for Complex Logic

```php
// âœ… Good: Use scope
AllowedFilter::scope('price_range')

// âŒ Bad: Complex callback
AllowedFilter::callback('price_range', function ($query, $value) {
    // Complex logic here
})
```

### 3. Limit Pagination Size

```php
->paginate(min(request('per_page', 20), 100)) // Max 100 items
```

### 4. Document API Endpoints

Provide clear documentation for available filters, sorts, includes.

### 5. Test API Queries

Write tests for all filter/sort combinations.

## Resources

- [Spatie Query Builder Docs](https://spatie.be/docs/laravel-query-builder)
- [GitHub Repository](https://github.com/spatie/laravel-query-builder)
- [JSON:API Specification](https://jsonapi.org/)

## Next Steps

- **[API Reference â†’](/api/rest)** - See all API endpoints with Query Builder
- **[Testing â†’](/extending/backend#testing)** - Test API queries
- **[Performance â†’](/advanced/performance)** - Optimize queries
