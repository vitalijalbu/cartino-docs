# Sanctum Authentication (Advanced)

Laravel Sanctum provides a lightweight authentication system for SPAs (Single Page Applications), mobile applications, and simple token-based APIs. Cartino uses Sanctum for both admin and customer authentication.

## Introduction

Sanctum offers two modes of authentication:
- ðŸª **Cookie-based (SPA)** - For Inertia.js admin panel and frontend
- ðŸ”‘ **Token-based (API)** - For mobile apps, third-party integrations

## Installation

Sanctum is pre-installed with Cartino. If needed:

```bash
composer require laravel/sanctum

php artisan vendor:publish --provider="Laravel\Sanctum\SanctumServiceProvider"
php artisan migrate
```

## Configuration

### Sanctum Config

`config/sanctum.php`:

```php
return [
    // Stateful domains (SPA)
    'stateful' => explode(',', env('SANCTUM_STATEFUL_DOMAINS', sprintf(
        '%s%s',
        'localhost,localhost:3000,127.0.0.1,127.0.0.1:8000,::1',
        env('APP_URL') ? ','.parse_url(env('APP_URL'), PHP_URL_HOST) : ''
    ))),

    // API token settings
    'expiration' => null, // Never expire (or set minutes)

    // Token prefix
    'token_prefix' => env('SANCTUM_TOKEN_PREFIX', ''),

    // Middleware
    'middleware' => [
        'verify_csrf_token' => App\Http\Middleware\VerifyCsrfToken::class,
        'encrypt_cookies' => App\Http\Middleware\EncryptCookies::class,
    ],
];
```

### Environment Variables

```env
SANCTUM_STATEFUL_DOMAINS=localhost,localhost:3000,admin.cartino.test
SESSION_DRIVER=cookie
SESSION_LIFETIME=120
SESSION_DOMAIN=.cartino.test
```

## Cookie-Based Authentication (SPA)

Used for Inertia.js admin panel and Vue storefront.

### Setup CORS

`config/cors.php`:

```php
return [
    'paths' => ['api/*', 'sanctum/csrf-cookie'],

    'allowed_methods' => ['*'],

    'allowed_origins' => [env('FRONTEND_URL', 'http://localhost:3000')],

    'allowed_origins_patterns' => [],

    'allowed_headers' => ['*'],

    'exposed_headers' => [],

    'max_age' => 0,

    'supports_credentials' => true, // Important!
];
```

### CSRF Protection

Before making authenticated requests, get CSRF cookie:

```javascript
// Get CSRF cookie first
await axios.get('/sanctum/csrf-cookie')

// Then authenticate
await axios.post('/login', {
  email: '[email protected]',
  password: 'password'
})
```

### Login Controller

```php
namespace App\Http\Controllers\Auth;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Validation\ValidationException;

class LoginController extends Controller
{
    public function login(Request $request)
    {
        $request->validate([
            'email' => 'required|email',
            'password' => 'required',
        ]);

        if (!Auth::attempt($request->only('email', 'password'), $request->boolean('remember'))) {
            throw ValidationException::withMessages([
                'email' => ['The provided credentials are incorrect.'],
            ]);
        }

        $request->session()->regenerate();

        return response()->json([
            'message' => 'Authenticated',
            'user' => $request->user(),
        ]);
    }

    public function logout(Request $request)
    {
        Auth::guard('web')->logout();

        $request->session()->invalidate();
        $request->session()->regenerateToken();

        return response()->json(['message' => 'Logged out']);
    }

    public function user(Request $request)
    {
        return response()->json($request->user());
    }
}
```

### Frontend Implementation

```javascript
// api.js
import axios from 'axios'

const api = axios.create({
  baseURL: 'https://api.cartino.test',
  withCredentials: true, // Important for cookies
  headers: {
    'Accept': 'application/json',
    'Content-Type': 'application/json',
  },
})

export default api
```

```javascript
// auth.js
import api from './api'

export async function login(email, password, remember = false) {
  // Get CSRF cookie
  await api.get('/sanctum/csrf-cookie')

  // Login
  const response = await api.post('/login', {
    email,
    password,
    remember,
  })

  return response.data
}

export async function logout() {
  await api.post('/logout')
}

export async function getUser() {
  const response = await api.get('/api/user')
  return response.data
}
```

### Protect Routes

```php
// routes/web.php
Route::middleware(['auth:sanctum'])->group(function () {
    Route::get('/dashboard', [DashboardController::class, 'index']);
    Route::resource('products', ProductController::class);
});
```

## Token-Based Authentication (API)

Used for mobile apps, third-party integrations, webhooks.

### Enable API Tokens

Add `HasApiTokens` trait to models:

```php
namespace App\Models;

use Illuminate\Foundation\Auth\User as Authenticatable;
use Laravel\Sanctum\HasApiTokens;

class User extends Authenticatable
{
    use HasApiTokens;
}
```

```php
class Customer extends Authenticatable
{
    use HasApiTokens;
}
```

### Create Tokens

```php
// Create token for user
$user = User::find(1);

$token = $user->createToken('admin-token')->plainTextToken;
// Returns: "1|randomTokenString"

// Create token with abilities (permissions)
$token = $user->createToken('admin-token', ['products:read', 'products:write'])->plainTextToken;

// Create token with expiration
$token = $user->createToken('admin-token', ['*'], now()->addDays(30))->plainTextToken;
```

### Token Login Endpoint

```php
namespace App\Http\Controllers\Api;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;
use Illuminate\Validation\ValidationException;
use App\Models\User;

class AuthController extends Controller
{
    public function login(Request $request)
    {
        $request->validate([
            'email' => 'required|email',
            'password' => 'required',
            'device_name' => 'required',
        ]);

        $user = User::where('email', $request->email)->first();

        if (!$user || !Hash::check($request->password, $user->password)) {
            throw ValidationException::withMessages([
                'email' => ['The provided credentials are incorrect.'],
            ]);
        }

        // Revoke existing tokens (optional)
        // $user->tokens()->delete();

        // Create new token
        $token = $user->createToken($request->device_name)->plainTextToken;

        return response()->json([
            'token' => $token,
            'user' => $user,
        ]);
    }

    public function logout(Request $request)
    {
        // Revoke current token
        $request->user()->currentAccessToken()->delete();

        return response()->json(['message' => 'Logged out']);
    }

    public function logoutAll(Request $request)
    {
        // Revoke all tokens
        $request->user()->tokens()->delete();

        return response()->json(['message' => 'Logged out from all devices']);
    }
}
```

### Using Tokens

```bash
# Request with Bearer token
curl -H "Authorization: Bearer 1|randomTokenString" \
     https://api.cartino.test/api/user
```

```javascript
// JavaScript
const response = await fetch('https://api.cartino.test/api/user', {
  headers: {
    'Authorization': `Bearer ${token}`,
    'Accept': 'application/json',
  },
})
```

### Protect API Routes

```php
// routes/api.php
Route::middleware('auth:sanctum')->group(function () {
    Route::get('/user', [UserController::class, 'show']);

    Route::apiResource('products', ProductController::class);
    Route::apiResource('orders', OrderController::class);
});
```

## Token Abilities (Scopes)

Define granular permissions for tokens:

### Create Token with Abilities

```php
$token = $user->createToken('mobile-app', [
    'products:read',
    'orders:read',
    'orders:create',
])->plainTextToken;
```

### Check Abilities in Controller

```php
public function destroy(Product $product)
{
    if (!auth()->user()->tokenCan('products:delete')) {
        abort(403, 'Unauthorized');
    }

    $product->delete();

    return response()->json(['message' => 'Product deleted']);
}
```

### Middleware for Abilities

```php
Route::middleware(['auth:sanctum', 'ability:products:delete'])
    ->delete('/products/{product}', [ProductController::class, 'destroy']);

// Multiple abilities (AND)
Route::middleware(['auth:sanctum', 'ability:products:read,products:write'])
    ->put('/products/{product}', [ProductController::class, 'update']);

// Multiple abilities (OR)
Route::middleware(['auth:sanctum', 'abilities:products:read,orders:read'])
    ->get('/dashboard', [DashboardController::class, 'index']);
```

### Cartino Default Abilities

```php
// Admin abilities
'admin:*'                    // Full admin access
'users:read'
'users:write'
'products:read'
'products:write'
'products:delete'
'orders:read'
'orders:write'
'customers:read'
'customers:write'
'settings:read'
'settings:write'

// Customer abilities
'customer:*'                 // Full customer access
'orders:read'                // View own orders
'profile:write'              // Edit own profile
'addresses:write'            // Manage addresses
```

## Multi-Guard Authentication

Separate authentication for admins and customers:

### Guards Configuration

`config/auth.php`:

```php
'guards' => [
    'web' => [
        'driver' => 'session',
        'provider' => 'users',
    ],

    'customer' => [
        'driver' => 'session',
        'provider' => 'customers',
    ],

    'api' => [
        'driver' => 'sanctum',
        'provider' => 'users',
    ],

    'customer-api' => [
        'driver' => 'sanctum',
        'provider' => 'customers',
    ],
],

'providers' => [
    'users' => [
        'driver' => 'eloquent',
        'model' => App\Models\User::class,
    ],

    'customers' => [
        'driver' => 'eloquent',
        'model' => App\Models\Customer::class,
    ],
],
```

### Admin API Routes

```php
// routes/api.php

// Admin API
Route::prefix('admin')->middleware('auth:sanctum')->group(function () {
    Route::get('/dashboard', [AdminDashboardController::class, 'index']);
    Route::apiResource('products', ProductController::class);
});
```

### Customer API Routes

```php
// Customer API (different guard)
Route::prefix('customer')->middleware('auth:customer-api')->group(function () {
    Route::get('/profile', [CustomerProfileController::class, 'show']);
    Route::get('/orders', [CustomerOrderController::class, 'index']);
});
```

### Login for Different Guards

```php
public function customerLogin(Request $request)
{
    $request->validate([
        'email' => 'required|email',
        'password' => 'required',
        'device_name' => 'required',
    ]);

    $customer = Customer::where('email', $request->email)->first();

    if (!$customer || !Hash::check($request->password, $customer->password)) {
        throw ValidationException::withMessages([
            'email' => ['The provided credentials are incorrect.'],
        ]);
    }

    $token = $customer->createToken($request->device_name)->plainTextToken;

    return response()->json([
        'token' => $token,
        'customer' => $customer,
    ]);
}
```

## Token Management

### List User Tokens

```php
$user = auth()->user();

$tokens = $user->tokens;

foreach ($tokens as $token) {
    echo $token->name; // Token name
    echo $token->abilities; // Permissions
    echo $token->last_used_at; // Last used
}
```

### Revoke Token

```php
// Revoke specific token
$user->tokens()->where('id', $tokenId)->delete();

// Revoke current token
$request->user()->currentAccessToken()->delete();

// Revoke all tokens except current
$user->tokens()->where('id', '!=', $user->currentAccessToken()->id)->delete();
```

### Token Expiration

Set expiration in config:

```php
// config/sanctum.php
'expiration' => 60 * 24 * 7, // 7 days in minutes
```

Or per-token:

```php
$token = $user->createToken('temp-token', ['*'], now()->addHours(1))->plainTextToken;
```

### Prune Expired Tokens

```bash
# Run daily
php artisan sanctum:prune-expired --hours=24
```

Schedule in `app/Console/Kernel.php`:

```php
protected function schedule(Schedule $schedule)
{
    $schedule->command('sanctum:prune-expired --hours=24')->daily();
}
```

## Rate Limiting

### Global Rate Limiting

`app/Http/Kernel.php`:

```php
protected $middlewareGroups = [
    'api' => [
        'throttle:api',
        \Illuminate\Routing\Middleware\SubstituteBindings::class,
    ],
];
```

`app/Providers/RouteServiceProvider.php`:

```php
protected function configureRateLimiting()
{
    RateLimiter::for('api', function (Request $request) {
        return Limit::perMinute(60)->by($request->user()?->id ?: $request->ip());
    });

    RateLimiter::for('login', function (Request $request) {
        return Limit::perMinute(5)->by($request->email . $request->ip());
    });
}
```

### Per-Route Rate Limiting

```php
Route::middleware(['auth:sanctum', 'throttle:30,1'])
    ->get('/expensive-operation', [Controller::class, 'method']);
```

### Per-User Rate Limiting

```php
RateLimiter::for('api', function (Request $request) {
    $user = $request->user();

    if ($user?->is_vip) {
        return Limit::perMinute(300); // VIP: 300 requests/min
    }

    return Limit::perMinute(60); // Regular: 60 requests/min
});
```

## Two-Factor Authentication (2FA)

### Install Fortify

```bash
composer require laravel/fortify

php artisan vendor:publish --provider="Laravel\Fortify\FortifyServiceProvider"
php artisan migrate
```

### Enable 2FA

`config/fortify.php`:

```php
'features' => [
    Features::twoFactorAuthentication([
        'confirm' => true,
        'confirmPassword' => true,
    ]),
],
```

### 2FA Setup Flow

```php
// Enable 2FA for user
$request->user()->enableTwoFactorAuthentication();

// Get QR code
$qrCode = $request->user()->twoFactorQrCodeSvg();

// Get recovery codes
$recoveryCodes = $request->user()->recoveryCodes();

return view('auth.two-factor', [
    'qrCode' => $qrCode,
    'recoveryCodes' => $recoveryCodes,
]);
```

### 2FA Login

```php
// After normal login, prompt for 2FA code
if ($user->two_factor_secret) {
    return response()->json([
        'two_factor' => true,
    ]);
}

// Verify 2FA code
$request->validate([
    'code' => 'required|string',
]);

if (!$user->confirmTwoFactorAuth($request->code)) {
    throw ValidationException::withMessages([
        'code' => ['The provided code is invalid.'],
    ]);
}

// Continue with authentication
$token = $user->createToken($request->device_name)->plainTextToken;
```

## API Key Authentication

For server-to-server integrations:

### API Key Model

```php
namespace App\Models;

class ApiKey extends Model
{
    protected $fillable = ['name', 'key', 'user_id', 'abilities', 'last_used_at'];

    protected $hidden = ['key'];

    protected $casts = [
        'abilities' => 'array',
        'last_used_at' => 'datetime',
    ];

    public static function generate(User $user, string $name, array $abilities = ['*'])
    {
        return self::create([
            'user_id' => $user->id,
            'name' => $name,
            'key' => 'sk_' . Str::random(64),
            'abilities' => $abilities,
        ]);
    }

    public function user()
    {
        return $this->belongsTo(User::class);
    }
}
```

### API Key Middleware

```php
namespace App\Http\Middleware;

class AuthenticateApiKey
{
    public function handle($request, $next)
    {
        $key = $request->header('X-API-Key');

        if (!$key) {
            abort(401, 'API key required');
        }

        $apiKey = ApiKey::where('key', hash('sha256', $key))->first();

        if (!$apiKey) {
            abort(401, 'Invalid API key');
        }

        // Update last used
        $apiKey->update(['last_used_at' => now()]);

        // Set authenticated user
        auth()->setUser($apiKey->user);

        return $next($request);
    }
}
```

### Use API Keys

```php
Route::middleware('api-key')->group(function () {
    Route::post('/webhooks/orders', [WebhookController::class, 'orders']);
});
```

Request:

```bash
curl -H "X-API-Key: sk_randomKeyString" \
     https://api.cartino.test/api/webhooks/orders
```

## Testing

### Fake Authentication

```php
use Laravel\Sanctum\Sanctum;

test('authenticated user can view dashboard', function () {
    $user = User::factory()->create();

    Sanctum::actingAs($user, ['*']);

    $response = $this->getJson('/api/dashboard');

    $response->assertOk();
});
```

### Test Token Abilities

```php
test('user with limited abilities cannot delete products', function () {
    $user = User::factory()->create();

    Sanctum::actingAs($user, ['products:read']);

    $product = Product::factory()->create();

    $response = $this->deleteJson("/api/products/{$product->id}");

    $response->assertForbidden();
});
```

### Test Rate Limiting

```php
test('api is rate limited', function () {
    $user = User::factory()->create();

    Sanctum::actingAs($user);

    for ($i = 0; $i < 60; $i++) {
        $this->getJson('/api/products');
    }

    $response = $this->getJson('/api/products');

    $response->assertStatus(429); // Too Many Requests
});
```

## Best Practices

### 1. Use Abilities for Granular Control

```php
// âœ… Good: Specific abilities
$token = $user->createToken('api', ['products:read', 'orders:read']);

// âŒ Bad: Wildcard for everything
$token = $user->createToken('api', ['*']);
```

### 2. Rotate Tokens Regularly

```php
// Revoke old tokens after 30 days
$user->tokens()->where('created_at', '<', now()->subDays(30))->delete();
```

### 3. Name Tokens Descriptively

```php
$token = $user->createToken('iPhone 14 - John'); // âœ…
$token = $user->createToken('token'); // âŒ
```

### 4. Log Token Usage

```php
// Track token activity
Log::info('Token used', [
    'user' => $request->user()->id,
    'token' => $request->user()->currentAccessToken()->name,
    'ip' => $request->ip(),
]);
```

### 5. Validate Device Names

```php
$request->validate([
    'device_name' => 'required|string|max:255|regex:/^[a-zA-Z0-9 ]+$/',
]);
```

## Troubleshooting

### CORS Issues

Ensure `supports_credentials: true` in CORS config:

```php
'supports_credentials' => true,
```

### 419 CSRF Token Mismatch

Get CSRF cookie before login:

```javascript
await axios.get('/sanctum/csrf-cookie')
```

### Token Not Working

Check:
- Token is not expired
- Bearer prefix in header
- Middleware applied to route

```bash
curl -v -H "Authorization: Bearer YOUR_TOKEN" https://api.cartino.test/api/user
```

## Resources

- [Laravel Sanctum Documentation](https://laravel.com/docs/sanctum)
- [SPA Authentication Guide](https://laravel.com/docs/sanctum#spa-authentication)
- [API Token Authentication](https://laravel.com/docs/sanctum#api-token-authentication)

## Next Steps

- **[Permissions â†’](/packages/permissions)** - Combine with role-based access
- **[API Reference â†’](/api/rest)** - API endpoints
- **[Testing â†’](/extending/backend#testing)** - Test authentication
