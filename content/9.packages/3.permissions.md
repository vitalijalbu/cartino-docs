# Spatie Roles & Permissions

Cartino uses **[Spatie Laravel Permission](https://spatie.be/docs/laravel-permission)** to provide a flexible role-based access control (RBAC) system for both admin users and customers.

## Introduction

The permission system allows you to:
- ðŸ” **Assign roles** to users (Admin, Manager, Customer, etc.)
- âœ… **Grant permissions** to roles or directly to users
- ðŸ›¡ï¸ **Protect routes and actions** with middleware
- ðŸŽ¯ **Check permissions** in controllers and views
- ðŸ“Š **Model-level permissions** for fine-grained control
- ðŸ”„ **Cache permissions** for performance

## Installation

Spatie Permission is pre-installed with Cartino. If needed:

```bash
composer require spatie/laravel-permission

php artisan vendor:publish --provider="Spatie\Permission\PermissionServiceProvider"
php artisan migrate
```

## Core Concepts

### Roles

A **role** is a named group of permissions (e.g., `admin`, `manager`, `customer`).

### Permissions

A **permission** is a specific action that can be performed (e.g., `edit products`, `view orders`).

### Guards

**Guards** separate permission sets for different user types (e.g., `web` for admins, `customer` for customers).

## Basic Usage

### Assigning Roles to Users

```php
use Spatie\Permission\Models\Role;

// Create a role
$role = Role::create(['name' => 'admin']);

// Assign role to user
$user->assignRole('admin');

// Assign multiple roles
$user->assignRole(['admin', 'editor']);

// Remove role
$user->removeRole('admin');

// Sync roles (removes all others)
$user->syncRoles(['admin', 'manager']);
```

### Checking Roles

```php
// Check if user has role
if ($user->hasRole('admin')) {
    // User is admin
}

// Check any role
if ($user->hasAnyRole(['admin', 'manager'])) {
    // User has at least one of these roles
}

// Check all roles
if ($user->hasAllRoles(['admin', 'manager'])) {
    // User has all these roles
}

// Check exact roles
if ($user->hasExactRoles(['admin', 'manager'])) {
    // User has ONLY these roles
}
```

### Assigning Permissions

```php
use Spatie\Permission\Models\Permission;

// Create permission
$permission = Permission::create(['name' => 'edit products']);

// Give permission to user
$user->givePermissionTo('edit products');

// Give multiple permissions
$user->givePermissionTo(['edit products', 'delete products']);

// Revoke permission
$user->revokePermissionTo('edit products');

// Sync permissions
$user->syncPermissions(['edit products', 'view orders']);
```

### Checking Permissions

```php
// Check if user has permission
if ($user->can('edit products')) {
    // User can edit products
}

// Check direct permission (bypassing roles)
if ($user->hasDirectPermission('edit products')) {
    // User has this permission directly
}

// Check permission via role
if ($user->hasPermissionTo('edit products')) {
    // User has permission (directly or via role)
}
```

### Assigning Permissions to Roles

```php
// Give permission to role
$role = Role::findByName('admin');
$role->givePermissionTo('edit products');

// Give multiple permissions
$role->givePermissionTo(['edit products', 'delete products', 'view orders']);

// Revoke permission from role
$role->revokePermissionTo('delete products');

// Sync permissions for role
$role->syncPermissions(['edit products', 'view products', 'view orders']);
```

## Middleware Protection

### Protect Routes

```php
// Single permission
Route::get('/products/edit', [ProductController::class, 'edit'])
    ->middleware('permission:edit products');

// Multiple permissions (OR)
Route::get('/dashboard', [DashboardController::class, 'index'])
    ->middleware('permission:view dashboard|view analytics');

// Multiple permissions (AND)
Route::get('/reports', [ReportController::class, 'index'])
    ->middleware('permission:view reports,generate reports');

// Role-based
Route::get('/admin', [AdminController::class, 'index'])
    ->middleware('role:admin');

// Multiple roles (OR)
Route::get('/manager', [ManagerController::class, 'index'])
    ->middleware('role:admin|manager');
```

### Route Groups

```php
Route::middleware(['role:admin'])->group(function () {
    Route::get('/users', [UserController::class, 'index']);
    Route::post('/users', [UserController::class, 'store']);
    Route::delete('/users/{user}', [UserController::class, 'destroy']);
});
```

### Combined Role and Permission

```php
Route::middleware(['role:admin', 'permission:edit products'])
    ->get('/products/edit', [ProductController::class, 'edit']);

// OR use pipe syntax
Route::middleware('role_or_permission:admin|edit products')
    ->get('/products/edit', [ProductController::class, 'edit']);
```

## Controller Usage

### Check in Controller

```php
namespace App\Http\Controllers;

class ProductController extends Controller
{
    public function edit(Product $product)
    {
        // Check permission
        $this->authorize('edit products');

        // Or use gate
        if (auth()->user()->cannot('edit products')) {
            abort(403, 'Unauthorized');
        }

        return view('products.edit', compact('product'));
    }

    public function destroy(Product $product)
    {
        // Check role
        if (!auth()->user()->hasRole('admin')) {
            abort(403, 'Only admins can delete products');
        }

        $product->delete();

        return redirect()->route('products.index');
    }
}
```

### Constructor Middleware

```php
class ProductController extends Controller
{
    public function __construct()
    {
        $this->middleware('permission:view products')->only(['index', 'show']);
        $this->middleware('permission:edit products')->only(['edit', 'update']);
        $this->middleware('permission:delete products')->only('destroy');
    }
}
```

## Blade Directives

### Check Roles

```blade
@role('admin')
    <a href="/admin">Admin Panel</a>
@endrole

@hasrole('admin')
    <p>You are an admin</p>
@endhasrole

@hasanyrole('admin|manager')
    <p>You are admin or manager</p>
@endhasanyrole

@hasallroles('admin|manager')
    <p>You have both admin and manager roles</p>
@endhasallroles
```

### Check Permissions

```blade
@can('edit products')
    <a href="/products/edit">Edit Products</a>
@endcan

@cannot('delete products')
    <p>You cannot delete products</p>
@endcannot

@canany(['edit products', 'delete products'])
    <a href="/products">Manage Products</a>
@endcanany
```

### Unify Role and Permission

```blade
@unlessrole('admin')
    <p>You are not an admin</p>
@endunlessrole
```

## Cartino Default Roles & Permissions

### Admin Roles

```php
// Super Admin - Full access
Role::create(['name' => 'super-admin', 'guard_name' => 'web']);

// Admin - Manage store
Role::create(['name' => 'admin', 'guard_name' => 'web']);

// Manager - Limited admin access
Role::create(['name' => 'manager', 'guard_name' => 'web']);

// Staff - Basic access
Role::create(['name' => 'staff', 'guard_name' => 'web']);
```

### Admin Permissions

```php
// Products
'view products'
'create products'
'edit products'
'delete products'
'publish products'

// Orders
'view orders'
'edit orders'
'cancel orders'
'refund orders'
'export orders'

// Customers
'view customers'
'create customers'
'edit customers'
'delete customers'

// Inventory
'view inventory'
'adjust inventory'
'transfer inventory'

// Settings
'view settings'
'edit settings'
'manage users'
'manage roles'

// Reports
'view reports'
'export reports'
```

### Customer Roles

```php
// Regular customer
Role::create(['name' => 'customer', 'guard_name' => 'customer']);

// VIP customer
Role::create(['name' => 'vip-customer', 'guard_name' => 'customer']);

// Wholesale customer
Role::create(['name' => 'wholesale', 'guard_name' => 'customer']);
```

### Customer Permissions

```php
// Orders
'view own orders'
'cancel own orders'
'download invoices'

// Account
'edit own profile'
'view order history'

// Wholesale-specific
'view wholesale prices'
'place bulk orders'
```

## Guards

Separate permissions for different user types:

### Configure Guards

In `config/auth.php`:

```php
'guards' => [
    'web' => [
        'driver' => 'session',
        'provider' => 'users',
    ],
    'customer' => [
        'driver' => 'session',
        'provider' => 'customers',
    ],
],

'providers' => [
    'users' => [
        'driver' => 'eloquent',
        'model' => App\Models\User::class,
    ],
    'customers' => [
        'driver' => 'eloquent',
        'model' => App\Models\Customer::class,
    ],
],
```

### Use Different Guards

```php
// Admin user (web guard)
$admin = User::find(1);
$admin->assignRole('admin'); // Uses 'web' guard by default

// Customer (customer guard)
$customer = Customer::find(1);
$customer->assignRole('customer'); // Specify guard
$customer->givePermissionTo('view own orders');

// Create role for specific guard
$role = Role::create(['name' => 'vip', 'guard_name' => 'customer']);
$permission = Permission::create(['name' => 'view wholesale prices', 'guard_name' => 'customer']);
```

### Check with Guards

```php
if ($customer->hasRole('vip', 'customer')) {
    // Customer has VIP role
}

if ($admin->can('edit products', 'web')) {
    // Admin can edit products
}
```

## Model Setup

### User Model

```php
namespace App\Models;

use Illuminate\Foundation\Auth\User as Authenticatable;
use Spatie\Permission\Traits\HasRoles;

class User extends Authenticatable
{
    use HasRoles;

    protected $guard_name = 'web'; // Default guard

    // Optional: Define default role
    protected static function boot()
    {
        parent::boot();

        static::created(function ($user) {
            $user->assignRole('staff'); // Default role
        });
    }
}
```

### Customer Model

```php
namespace App\Models;

use Illuminate\Foundation\Auth\User as Authenticatable;
use Spatie\Permission\Traits\HasRoles;

class Customer extends Authenticatable
{
    use HasRoles;

    protected $guard_name = 'customer';

    protected static function boot()
    {
        parent::boot();

        static::created(function ($customer) {
            $customer->assignRole('customer'); // Default role
        });
    }
}
```

## Seeding Roles & Permissions

### Database Seeder

```php
namespace Database\Seeders;

use Illuminate\Database\Seeder;
use Spatie\Permission\Models\Role;
use Spatie\Permission\Models\Permission;

class RolePermissionSeeder extends Seeder
{
    public function run(): void
    {
        // Reset cached roles and permissions
        app()[\Spatie\Permission\PermissionRegistrar::class]->forgetCachedPermissions();

        // Create permissions
        $permissions = [
            // Products
            'view products',
            'create products',
            'edit products',
            'delete products',

            // Orders
            'view orders',
            'edit orders',
            'cancel orders',
            'refund orders',

            // Customers
            'view customers',
            'edit customers',

            // Settings
            'manage settings',
            'manage users',
        ];

        foreach ($permissions as $permission) {
            Permission::create(['name' => $permission, 'guard_name' => 'web']);
        }

        // Create roles and assign permissions
        $superAdmin = Role::create(['name' => 'super-admin']);
        $superAdmin->givePermissionTo(Permission::all()); // All permissions

        $admin = Role::create(['name' => 'admin']);
        $admin->givePermissionTo([
            'view products',
            'create products',
            'edit products',
            'view orders',
            'edit orders',
            'view customers',
        ]);

        $manager = Role::create(['name' => 'manager']);
        $manager->givePermissionTo([
            'view products',
            'edit products',
            'view orders',
        ]);

        $staff = Role::create(['name' => 'staff']);
        $staff->givePermissionTo([
            'view products',
            'view orders',
        ]);

        // Customer roles
        $customer = Role::create(['name' => 'customer', 'guard_name' => 'customer']);
        Permission::create(['name' => 'view own orders', 'guard_name' => 'customer']);
        $customer->givePermissionTo('view own orders');
    }
}
```

Run seeder:

```bash
php artisan db:seed --class=RolePermissionSeeder
```

## Super Admin

### Give All Permissions

```php
// Method 1: Use wildcard permission
$superAdmin = Role::create(['name' => 'super-admin']);
Permission::create(['name' => '*']); // Wildcard permission
$superAdmin->givePermissionTo('*');

// Check
if ($user->can('*')) {
    // Super admin can do anything
}
```

### Custom Gate for Super Admin

In `AuthServiceProvider`:

```php
use Illuminate\Support\Facades\Gate;

public function boot(): void
{
    // Super admin bypass
    Gate::before(function ($user, $ability) {
        return $user->hasRole('super-admin') ? true : null;
    });
}
```

Now super-admin can do anything without explicit permissions.

## API Integration

### Assign Roles API

```php
// routes/api.php
Route::middleware('auth:sanctum')->group(function () {
    Route::post('/users/{user}/roles', [UserRoleController::class, 'assign']);
    Route::delete('/users/{user}/roles/{role}', [UserRoleController::class, 'remove']);
    Route::post('/users/{user}/permissions', [UserPermissionController::class, 'assign']);
});
```

```php
// UserRoleController.php
public function assign(Request $request, User $user)
{
    $request->validate([
        'role' => 'required|exists:roles,name',
    ]);

    // Check permission
    if (!auth()->user()->can('manage users')) {
        abort(403, 'Unauthorized');
    }

    $user->assignRole($request->role);

    return response()->json([
        'message' => 'Role assigned successfully',
        'user' => $user->load('roles'),
    ]);
}

public function remove(User $user, string $role)
{
    if (!auth()->user()->can('manage users')) {
        abort(403, 'Unauthorized');
    }

    $user->removeRole($role);

    return response()->json([
        'message' => 'Role removed successfully',
    ]);
}
```

### Check Permissions in API

```php
Route::middleware(['auth:sanctum', 'permission:edit products'])
    ->put('/products/{product}', [ProductController::class, 'update']);
```

## Admin Panel Integration

### Role Management UI

```vue
<template>
  <div class="role-manager">
    <h2>Manage User Roles</h2>

    <form @submit.prevent="assignRole">
      <select v-model="selectedRole">
        <option v-for="role in roles" :key="role.id" :value="role.name">
          {{ role.name }}
        </option>
      </select>

      <button type="submit">Assign Role</button>
    </form>

    <div class="current-roles">
      <h3>Current Roles</h3>
      <div v-for="role in user.roles" :key="role.id" class="role-badge">
        {{ role.name }}
        <button @click="removeRole(role.name)">Ã—</button>
      </div>
    </div>

    <div class="permissions">
      <h3>Permissions</h3>
      <label v-for="permission in permissions" :key="permission.id">
        <input
          type="checkbox"
          :checked="hasPermission(permission.name)"
          @change="togglePermission(permission.name)"
        />
        {{ permission.name }}
      </label>
    </div>
  </div>
</template>

<script setup>
import { ref } from 'vue'

const props = defineProps(['user', 'roles', 'permissions'])
const selectedRole = ref('')

const assignRole = async () => {
  await axios.post(`/api/users/${props.user.id}/roles`, {
    role: selectedRole.value,
  })
  // Reload user data
}

const removeRole = async (roleName) => {
  await axios.delete(`/api/users/${props.user.id}/roles/${roleName}`)
}

const togglePermission = async (permissionName) => {
  const hasIt = hasPermission(permissionName)

  if (hasIt) {
    await axios.delete(`/api/users/${props.user.id}/permissions/${permissionName}`)
  } else {
    await axios.post(`/api/users/${props.user.id}/permissions`, {
      permission: permissionName,
    })
  }
}

const hasPermission = (name) => {
  return props.user.permissions?.some(p => p.name === name) ?? false
}
</script>
```

## Permission Caching

### Clear Cache

```bash
# Clear permission cache
php artisan permission:cache-reset
```

### Automatic Cache

Permissions are cached automatically. To manually re-cache:

```bash
php artisan permission:cache-reset
```

### Disable Cache (Development)

In `config/permission.php`:

```php
'cache' => [
    'expiration_time' => \DateInterval::createFromDateString('24 hours'),
    'key' => 'spatie.permission.cache',
    'store' => 'default',
],
```

Set to 0 to disable:

```php
'expiration_time' => 0, // Disable cache
```

## Advanced Usage

### Hierarchical Roles

Create role hierarchy:

```php
// In AuthServiceProvider
Gate::before(function ($user, $ability) {
    // Super admin can do everything
    if ($user->hasRole('super-admin')) {
        return true;
    }

    // Admin inherits manager permissions
    if ($user->hasRole('admin') && $ability === 'view reports') {
        return true;
    }
});
```

### Team-Based Permissions

For multi-tenancy:

```php
// Add team_id to roles/permissions tables
Schema::table('roles', function (Blueprint $table) {
    $table->foreignId('team_id')->nullable()->constrained();
});

// Check permission for specific team
if ($user->hasPermissionTo('edit products', 'web', $teamId)) {
    // User can edit products for this team
}
```

### Temporary Permissions

```php
// Give temporary permission (not saved to DB)
$user->givePermissionTo('special access');

// Check
if ($user->hasPermissionTo('special access')) {
    // Access granted
}

// Later revoke
$user->revokePermissionTo('special access');
```

### Scoped Permissions

Permission for specific resources:

```php
// Create permissions like: "edit product:123"
Permission::create(['name' => 'edit product:123']);

// Assign
$user->givePermissionTo('edit product:123');

// Check
if ($user->can('edit product:' . $product->id)) {
    // Can edit this specific product
}
```

## Testing

### Fake Permissions in Tests

```php
use Spatie\Permission\Models\Role;
use Spatie\Permission\Models\Permission;

test('admin can edit products', function () {
    $admin = User::factory()->create();
    $admin->assignRole('admin');

    $permission = Permission::create(['name' => 'edit products']);
    $admin->givePermissionTo($permission);

    $this->actingAs($admin)
        ->get('/products/edit')
        ->assertOk();
});

test('staff cannot delete products', function () {
    $staff = User::factory()->create();
    $staff->assignRole('staff');

    $this->actingAs($staff)
        ->delete('/products/1')
        ->assertForbidden();
});
```

## Troubleshooting

### Permission Denied Issues

```bash
# Clear cache
php artisan permission:cache-reset
php artisan cache:clear

# Re-migrate if needed
php artisan migrate:fresh --seed
```

### Role Not Found

Ensure guard name matches:

```php
// Specify guard explicitly
$role = Role::findByName('admin', 'web');
$user->assignRole($role);
```

### Performance Issues

```php
// Eager load roles and permissions
$users = User::with('roles.permissions')->get();

// Cache permissions
php artisan permission:cache-reset
```

## Best Practices

### 1. Use Descriptive Permission Names

```php
// âœ… Good
'create products'
'edit own profile'
'view sales reports'

// âŒ Bad
'product_create'
'profile'
'reports'
```

### 2. Group Permissions Logically

```php
// Product permissions
'view products'
'create products'
'edit products'
'delete products'

// Order permissions
'view orders'
'edit orders'
'cancel orders'
```

### 3. Use Roles, Not Direct Permissions

```php
// âœ… Good: Assign role with permissions
$user->assignRole('admin');

// âŒ Bad: Assign each permission individually
$user->givePermissionTo(['edit products', 'view orders', ...]);
```

### 4. Protect Sensitive Routes

```php
// Always protect admin routes
Route::middleware(['auth', 'role:admin'])->group(function () {
    // Admin routes
});
```

### 5. Check Permissions, Not Roles

```php
// âœ… Good: Check permission
if ($user->can('edit products')) {}

// âŒ Bad: Check role
if ($user->hasRole('admin')) {}
```

## Resources

- [Spatie Permission Official Docs](https://spatie.be/docs/laravel-permission)
- [GitHub Repository](https://github.com/spatie/laravel-permission)
- [Best Practices Guide](https://spatie.be/docs/laravel-permission/best-practices)

## Next Steps

- **[API Authentication â†’](/packages/sanctum-advanced)** - Secure API endpoints
- **[Admin Panel â†’](/user-guide/admin-panel)** - Role management UI
- **[Testing â†’](/extending/backend#testing)** - Test permissions
