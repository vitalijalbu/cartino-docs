# Mail & Mailable Classes

Cartino uses Laravel's Mailable classes to send beautiful, customizable transactional emails for orders, shipments, customer notifications, and more.

## Introduction

Mailables provide a clean way to build email messages with:
- ðŸ“§ **Rich HTML templates** using Blade
- ðŸŽ¨ **Markdown email components** for quick styling
- ðŸ“Ž **Attachments** (PDFs, invoices, etc.)
- ðŸ§ª **Easy testing** with Mail fakes
- ðŸ“¬ **Queue support** for async sending
- ðŸŒ **Multi-language** email templates

## Creating Mailables

### Generate Mailable Class

```bash
php artisan make:mail OrderConfirmation
```

This creates `app/Mail/OrderConfirmation.php`:

```php
namespace App\Mail;

use Illuminate\Bus\Queueable;
use Illuminate\Mail\Mailable;
use Illuminate\Mail\Mailables\Content;
use Illuminate\Mail\Mailables\Envelope;
use Illuminate\Queue\SerializesModels;

class OrderConfirmation extends Mailable
{
    use Queueable, SerializesModels;

    public function __construct(
        public Order $order
    ) {}

    public function envelope(): Envelope
    {
        return new Envelope(
            subject: "Order #{$this->order->number} Confirmed",
        );
    }

    public function content(): Content
    {
        return new Content(
            view: 'emails.orders.confirmation',
        );
    }

    public function attachments(): array
    {
        return [];
    }
}
```

### Sending the Mailable

```php
use App\Mail\OrderConfirmation;
use Illuminate\Support\Facades\Mail;

// Send immediately
Mail::to($customer->email)->send(new OrderConfirmation($order));

// Send to multiple recipients
Mail::to($customer->email)
    ->cc('[email protected]')
    ->bcc('[email protected]')
    ->send(new OrderConfirmation($order));
```

## Email Views

### Blade Template

Create `resources/views/emails/orders/confirmation.blade.php`:

```blade
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Order Confirmation</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 2px solid #3490dc;
        }
        .order-details {
            margin: 30px 0;
        }
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .items-table th,
        .items-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .total {
            font-size: 1.2em;
            font-weight: bold;
            text-align: right;
            margin-top: 20px;
        }
        .button {
            display: inline-block;
            padding: 12px 24px;
            background-color: #3490dc;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Thank You for Your Order!</h1>
        </div>

        <div class="order-details">
            <p>Hi {{ $order->customer->name }},</p>
            <p>Your order has been confirmed and will be shipped soon.</p>

            <p><strong>Order Number:</strong> #{{ $order->number }}</p>
            <p><strong>Order Date:</strong> {{ $order->created_at->format('F j, Y') }}</p>

            <h2>Order Items</h2>
            <table class="items-table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Quantity</th>
                        <th>Price</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach($order->items as $item)
                    <tr>
                        <td>{{ $item->product->name }}</td>
                        <td>{{ $item->quantity }}</td>
                        <td>{{ money($item->price) }}</td>
                    </tr>
                    @endforeach
                </tbody>
            </table>

            <div class="total">
                Total: {{ money($order->total) }}
            </div>

            <center>
                <a href="{{ route('orders.show', $order) }}" class="button">
                    View Order Details
                </a>
            </center>
        </div>

        <p>Thank you for shopping with us!</p>
        <p>- The {{ config('app.name') }} Team</p>
    </div>
</body>
</html>
```

## Markdown Mailables

For simpler emails, use Markdown:

### Generate Markdown Mailable

```bash
php artisan make:mail OrderShipped --markdown=emails.orders.shipped
```

### Mailable Class

```php
namespace App\Mail;

use Illuminate\Mail\Mailable;
use Illuminate\Mail\Mailables\Content;

class OrderShipped extends Mailable
{
    public function __construct(
        public Order $order,
        public string $trackingNumber
    ) {}

    public function content(): Content
    {
        return new Content(
            markdown: 'emails.orders.shipped',
        );
    }
}
```

### Markdown Template

Create `resources/views/emails/orders/shipped.blade.php`:

```blade
@component('mail::message')
# Order Shipped!

Hi {{ $order->customer->name }},

Great news! Your order **#{{ $order->number }}** has been shipped and is on its way.

## Tracking Information

**Tracking Number:** {{ $trackingNumber }}

@component('mail::button', ['url' => $trackingUrl])
Track Your Order
@endcomponent

## Order Summary

@component('mail::table')
| Product | Quantity | Price |
| ------- | -------- | ----- |
@foreach($order->items as $item)
| {{ $item->product->name }} | {{ $item->quantity }} | {{ money($item->price) }} |
@endforeach
@endcomponent

**Total:** {{ money($order->total) }}

Thanks for shopping with us!

Best regards,<br>
{{ config('app.name') }}
@endcomponent
```

### Markdown Components

Available components:

```blade
{{-- Button --}}
@component('mail::button', ['url' => $url, 'color' => 'success'])
Button Text
@endcomponent

{{-- Panel --}}
@component('mail::panel')
This is a panel with highlighted content.
@endcomponent

{{-- Table --}}
@component('mail::table')
| Column 1 | Column 2 |
| -------- | -------- |
| Value 1  | Value 2  |
@endcomponent

{{-- Subcopy (small text at bottom) --}}
@slot('subcopy')
This is additional information shown at the bottom.
@endslot
```

## Customizing Email Design

### Publish Mail Views

```bash
php artisan vendor:publish --tag=laravel-mail
```

This creates customizable templates in `resources/views/vendor/mail`.

### Customize Layout

Edit `resources/views/vendor/mail/html/layout.blade.php`:

```blade
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Your custom styles */
        .header {
            background-color: {{ $headerColor ?? '#3490dc' }};
        }
    </style>
</head>
<body>
    @isset($header)
        {{ $header }}
    @else
        <div class="header">
            <a href="{{ config('app.url') }}">
                <img src="{{ asset('images/logo.png') }}" alt="Logo">
            </a>
        </div>
    @endisset

    {{ $slot }}

    @isset($footer)
        {{ $footer }}
    @else
        <div class="footer">
            <p>&copy; {{ date('Y') }} {{ config('app.name') }}. All rights reserved.</p>
        </div>
    @endisset
</body>
</html>
```

### Customize Theme

Edit `config/mail.php`:

```php
'theme' => 'cartino', // Custom theme
```

Create theme in `resources/views/vendor/mail/html/themes/cartino.css`:

```css
/* Primary Colors */
.button-primary {
    background-color: #3490dc;
}

/* Typography */
body {
    font-family: 'Inter', Arial, sans-serif;
}

h1 {
    color: #2d3748;
}

/* Responsive */
@media only screen and (max-width: 600px) {
    .inner-body {
        width: 100% !important;
    }
}
```

## Attachments

### Attach Files

```php
use Illuminate\Mail\Mailables\Attachment;

public function attachments(): array
{
    return [
        Attachment::fromPath('/path/to/file.pdf')
            ->as('invoice.pdf')
            ->withMime('application/pdf'),
    ];
}
```

### Attach from Disk

```php
public function attachments(): array
{
    return [
        Attachment::fromStorage('/invoices/123.pdf')
            ->as('invoice.pdf'),
    ];
}
```

### Attach from Data

```php
public function attachments(): array
{
    return [
        Attachment::fromData(fn () => $this->pdf->output(), 'invoice.pdf')
            ->withMime('application/pdf'),
    ];
}
```

### Attach Media Library Files

```php
public function attachments(): array
{
    $invoice = $this->order->getFirstMedia('invoices');

    return [
        Attachment::fromPath($invoice->getPath())
            ->as('invoice.pdf')
            ->withMime('application/pdf'),
    ];
}
```

## Advanced Features

### Custom Headers

```php
use Illuminate\Mail\Mailables\Envelope;
use Illuminate\Mail\Mailables\Headers;

public function envelope(): Envelope
{
    return new Envelope(
        subject: 'Order Confirmation',
        tags: ['orders'],
        metadata: [
            'order_id' => $this->order->id,
        ],
    );
}

public function headers(): Headers
{
    return new Headers(
        messageId: "[email protected]",
        references: ['[email protected]'],
        text: [
            'X-Order-ID' => $this->order->id,
        ],
    );
}
```

### Custom From Address

```php
public function envelope(): Envelope
{
    return new Envelope(
        from: new Address('[email protected]', 'Cartino Support'),
        subject: 'Order Confirmation',
    );
}
```

### Reply To

```php
public function envelope(): Envelope
{
    return new Envelope(
        replyTo: [
            new Address('[email protected]', 'Customer Support'),
        ],
        subject: 'Order Confirmation',
    );
}
```

### Priority

```php
use Illuminate\Mail\Mailables\Envelope;

public function envelope(): Envelope
{
    return new Envelope(
        subject: 'Urgent: Order Issue',
        priority: 1, // 1 = Highest, 5 = Lowest
    );
}
```

## Queued Mailables

### Make Mailable Queueable

```php
use Illuminate\Contracts\Queue\ShouldQueue;

class OrderConfirmation extends Mailable implements ShouldQueue
{
    use Queueable, SerializesModels;

    // Automatically queued when sent
}
```

### Queue Configuration

```php
public function __construct(Order $order)
{
    $this->order = $order;

    // Custom queue
    $this->onQueue('emails');

    // Custom connection
    $this->onConnection('redis');

    // Delay sending
    $this->delay(now()->addMinutes(5));

    // Max attempts
    $this->tries = 3;

    // Timeout
    $this->timeout = 120;
}
```

### Send Now (Bypass Queue)

```php
// Send immediately even if implements ShouldQueue
Mail::to($customer)->sendNow(new OrderConfirmation($order));
```

## Localization

### Per-User Language

```php
use Illuminate\Support\Facades\Mail;

Mail::to($customer->email)
    ->locale($customer->locale)
    ->send(new OrderConfirmation($order));
```

### Translatable Content

In mailable:

```php
public function content(): Content
{
    return new Content(
        markdown: 'emails.orders.confirmation',
        with: [
            'greeting' => __('mail.greeting', ['name' => $this->order->customer->name]),
        ],
    );
}
```

Language files:

```php
// resources/lang/en/mail.php
return [
    'greeting' => 'Hi :name,',
    'order_confirmed' => 'Your order has been confirmed!',
];

// resources/lang/it/mail.php
return [
    'greeting' => 'Ciao :name,',
    'order_confirmed' => 'Il tuo ordine Ã¨ stato confermato!',
];
```

In Blade:

```blade
<p>{{ __('mail.greeting', ['name' => $order->customer->name]) }}</p>
<p>{{ __('mail.order_confirmed') }}</p>
```

## Testing Mailables

### Fake Mail

```php
use Illuminate\Support\Facades\Mail;

test('order confirmation email is sent', function () {
    Mail::fake();

    $order = Order::factory()->create();

    // Trigger email
    Mail::to($order->customer)->send(new OrderConfirmation($order));

    // Assert email was sent
    Mail::assertSent(OrderConfirmation::class, function ($mail) use ($order) {
        return $mail->order->id === $order->id;
    });
});
```

### Assert Multiple Emails

```php
Mail::assertSent(OrderConfirmation::class, 2); // Sent twice
```

### Assert Not Sent

```php
Mail::assertNotSent(OrderCancelled::class);
```

### Assert Queued

```php
Mail::assertQueued(OrderConfirmation::class);
```

### Preview Emails

```php
use App\Mail\OrderConfirmation;

Route::get('/preview-email', function () {
    $order = Order::first();

    return new OrderConfirmation($order);
});
```

Visit `/preview-email` to see the rendered email in browser.

## Cartino Built-in Mailables

### Order Emails

```php
// app/Mail/Order/
OrderConfirmation           // Order placed
OrderProcessing            // Order being prepared
OrderShipped               // Order shipped
OrderDelivered             // Order delivered
OrderCancelled             // Order cancelled
OrderRefunded              // Order refunded
```

### Customer Emails

```php
// app/Mail/Customer/
WelcomeEmail               // Account created
PasswordResetEmail         // Password reset
EmailVerification          // Verify email
AccountUpdated             // Profile changed
```

### Marketing Emails

```php
// app/Mail/Marketing/
AbandonedCartEmail         // Cart reminder
WishlistItemOnSale         // Wishlist discount
NewProductLaunch           // New product
ExclusiveOffer             // Promo code
```

## Email Configuration

### SMTP Configuration

In `.env`:

```env
MAIL_MAILER=smtp
MAIL_HOST=smtp.mailtrap.io
MAIL_PORT=2525
MAIL_USERNAME=your_username
MAIL_PASSWORD=your_password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS="[email protected]"
MAIL_FROM_NAME="${APP_NAME}"
```

### Popular Providers

**Mailgun:**

```env
MAIL_MAILER=mailgun
MAILGUN_DOMAIN=mg.yourdomain.com
MAILGUN_SECRET=your-mailgun-key
```

**SendGrid:**

```env
MAIL_MAILER=smtp
MAIL_HOST=smtp.sendgrid.net
MAIL_PORT=587
MAIL_USERNAME=apikey
MAIL_PASSWORD=your-sendgrid-api-key
```

**Amazon SES:**

```env
MAIL_MAILER=ses
AWS_ACCESS_KEY_ID=your-key
AWS_SECRET_ACCESS_KEY=your-secret
AWS_DEFAULT_REGION=us-east-1
```

## Email Events

Listen to mail events:

### Register Listeners

In `EventServiceProvider`:

```php
use Illuminate\Mail\Events\MessageSending;
use Illuminate\Mail\Events\MessageSent;

protected $listen = [
    MessageSending::class => [
        LogSendingMessage::class,
    ],
    MessageSent::class => [
        LogSentMessage::class,
    ],
];
```

### Log Sent Emails

```php
namespace App\Listeners;

use Illuminate\Mail\Events\MessageSent;

class LogSentMessage
{
    public function handle(MessageSent $event): void
    {
        // Log to database
        EmailLog::create([
            'to' => $event->message->getTo(),
            'subject' => $event->message->getSubject(),
            'sent_at' => now(),
        ]);
    }
}
```

## Rate Limiting

Prevent email spam:

```php
use Illuminate\Support\Facades\RateLimiter;

public function send($mailable)
{
    $executed = RateLimiter::attempt(
        'send-email:' . $this->customer->id,
        $maxAttempts = 5,
        function () use ($mailable) {
            Mail::to($this->customer)->send($mailable);
        },
        $decaySeconds = 60
    );

    if (!$executed) {
        throw new Exception('Too many emails sent. Please wait.');
    }
}
```

## Email Verification

Built into Laravel:

### Enable Email Verification

```php
use Illuminate\Contracts\Auth\MustVerifyEmail;

class Customer extends Authenticatable implements MustVerifyEmail
{
    use Notifiable;
}
```

### Send Verification Email

```php
use Illuminate\Auth\Notifications\VerifyEmail;

$customer->sendEmailVerificationNotification();
```

### Customize Verification Email

```php
use Illuminate\Notifications\Messages\MailMessage;
use Illuminate\Auth\Notifications\VerifyEmail;

VerifyEmail::toMailUsing(function ($notifiable, $url) {
    return (new MailMessage)
        ->subject('Verify Your Email Address')
        ->line('Click the button below to verify your email.')
        ->action('Verify Email', $url)
        ->line('If you did not create an account, no further action is required.');
});
```

## Email Templates Best Practices

### 1. Mobile Responsive

```html
<style>
    @media only screen and (max-width: 600px) {
        .container {
            width: 100% !important;
        }
        .button {
            display: block !important;
            width: 100% !important;
        }
    }
</style>
```

### 2. Inline CSS

Many email clients strip `<style>` tags:

```bash
# Use CSS inliner
composer require tijsverkoyen/css-to-inline-styles
```

Or use services like [Maizzle](https://maizzle.com/).

### 3. Plain Text Version

```php
public function content(): Content
{
    return new Content(
        view: 'emails.orders.confirmation',
        text: 'emails.orders.confirmation-text', // Plain text version
    );
}
```

Plain text template:

```
Hi {{ $order->customer->name }},

Your order #{{ $order->number }} has been confirmed!

Order Items:
@foreach($order->items as $item)
- {{ $item->product->name }} ({{ $item->quantity }}x) - {{ money($item->price) }}
@endforeach

Total: {{ money($order->total) }}

View order: {{ route('orders.show', $order) }}

Thanks!
```

### 4. Test in Multiple Clients

Use services like:
- [Litmus](https://litmus.com/)
- [Email on Acid](https://www.emailonacid.com/)
- [Mailtrap](https://mailtrap.io/)

### 5. Include Unsubscribe Link

```blade
<p>
    Don't want to receive these emails?
    <a href="{{ route('unsubscribe', ['email' => $customer->email]) }}">
        Unsubscribe
    </a>
</p>
```

## Troubleshooting

### Emails Not Sending

```bash
# Check configuration
php artisan config:clear
php artisan config:cache

# Check queue (if queued)
php artisan queue:work

# Check logs
tail -f storage/logs/laravel.log
```

### Test Email Sending

```bash
# Send test email
php artisan tinker

>>> Mail::raw('Test email', function ($msg) {
...     $msg->to('[email protected]')
...         ->subject('Test');
... });
```

### Preview in Mailtrap

In development, use Mailtrap to catch all emails:

```env
MAIL_MAILER=smtp
MAIL_HOST=smtp.mailtrap.io
MAIL_PORT=2525
MAIL_USERNAME=your_username
MAIL_PASSWORD=your_password
MAIL_ENCRYPTION=tls
```

### Deliverability Issues

- Check SPF/DKIM records
- Avoid spam trigger words
- Include plain text version
- Monitor bounce rates
- Use reputable SMTP provider

## Resources

- [Laravel Mail Documentation](https://laravel.com/docs/mail)
- [Markdown Mail Components](https://laravel.com/docs/mail#markdown-mailables)
- [Maizzle - Email Framework](https://maizzle.com/)
- [MJML - Responsive Email Framework](https://mjml.io/)
- [Mailtrap - Email Testing](https://mailtrap.io/)

## Next Steps

- **[Notifications â†’](/packages/notifications)** - Learn about notification channels
- **[Events & Listeners â†’](/extending/events)** - Trigger emails from events
- **[Theme System â†’](/extending/theme-distribution)** - Customize email templates per theme
