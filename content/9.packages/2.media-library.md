# Spatie Media Library

Cartino uses **[Spatie Media Library](https://spatie.be/docs/laravel-medialibrary)** to handle all media management including product images, customer avatars, documents, and more.

## Introduction

The Media Library package provides a seamless way to associate files with Eloquent models. It handles:

- File uploads and storage
- Image conversions (thumbnails, crops, resizes)
- Responsive images
- Media collections
- Custom properties
- File manipulation

## Installation

The Media Library comes pre-installed with Cartino. If you need to reinstall:

```bash
composer require spatie/laravel-medialibrary

php artisan vendor:publish --provider="Spatie\MediaLibrary\MediaLibraryServiceProvider" --tag="migrations"
php artisan migrate
```

## Basic Usage

### Making Models Media-Compatible

To enable media on a model, implement the `HasMedia` interface and use the `InteractsWithMedia` trait:

```php
use Spatie\MediaLibrary\HasMedia;
use Spatie\MediaLibrary\InteractsWithMedia;

class Product extends Model implements HasMedia
{
    use InteractsWithMedia;

    // Optional: Register media collections
    public function registerMediaCollections(): void
    {
        $this->addMediaCollection('images')
            ->useFallbackUrl('/images/placeholder.jpg')
            ->useFallbackPath(public_path('/images/placeholder.jpg'));

        $this->addMediaCollection('documents')
            ->acceptsMimeTypes(['application/pdf', 'application/msword']);
    }
}
```

### Uploading Files

#### From Request

```php
// In your controller
public function uploadImage(Request $request, Product $product)
{
    $product->addMediaFromRequest('image')
        ->toMediaCollection('images');

    return response()->json(['message' => 'Image uploaded successfully']);
}
```

#### From Disk

```php
$product->addMedia(storage_path('temp/image.jpg'))
    ->toMediaCollection('images');
```

#### From URL

```php
$product->addMediaFromUrl('https://example.com/image.jpg')
    ->toMediaCollection('images');
```

#### From Base64

```php
$product->addMediaFromBase64($base64String)
    ->toMediaCollection('images');
```

### Retrieving Media

#### Get All Media

```php
$mediaItems = $product->getMedia('images');

foreach ($mediaItems as $media) {
    echo $media->getUrl(); // Full URL
    echo $media->getPath(); // Disk path
}
```

#### Get First Media

```php
$media = $product->getFirstMedia('images');

if ($media) {
    echo $media->getUrl();
}
```

#### Get First Media URL

```php
// Returns URL or empty string
$url = $product->getFirstMediaUrl('images');

// Returns URL or fallback
$url = $product->getFirstMediaUrl('images', 'thumb');
```

### Deleting Media

```php
// Delete specific media item
$media = $product->getFirstMedia('images');
$media->delete();

// Clear all media in collection
$product->clearMediaCollection('images');

// Clear all media
$product->clearMediaCollections();
```

## Media Collections

Collections let you organize media into groups (e.g., product images vs documents).

### Defining Collections

```php
public function registerMediaCollections(): void
{
    // Images collection with single file
    $this->addMediaCollection('avatar')
        ->singleFile(); // Only one file allowed

    // Product images (multiple)
    $this->addMediaCollection('images')
        ->useFallbackUrl('/images/no-image.jpg');

    // Documents with mime type restrictions
    $this->addMediaCollection('documents')
        ->acceptsMimeTypes(['application/pdf'])
        ->maxFilesize(10 * 1024 * 1024); // 10MB
}
```

### Collection Options

```php
$this->addMediaCollection('images')
    ->singleFile()                                    // Only one file
    ->onlyKeepLatest(5)                              // Keep max 5 files
    ->acceptsMimeTypes(['image/jpeg', 'image/png'])  // Allowed types
    ->maxFilesize(5 * 1024 * 1024)                   // Max 5MB
    ->useFallbackUrl('/placeholder.jpg')              // Fallback image
    ->useFallbackPath(public_path('placeholder.jpg')) // Fallback path
    ->registerMediaConversions(function (Media $media) {
        // See conversions section
    });
```

## Image Conversions

Conversions automatically generate different sizes/versions of images.

### Defining Conversions

```php
use Spatie\MediaLibrary\MediaCollections\Models\Media;

public function registerMediaConversions(Media $media = null): void
{
    // Thumbnail
    $this->addMediaConversion('thumb')
        ->width(150)
        ->height(150)
        ->sharpen(10);

    // Product card
    $this->addMediaConversion('card')
        ->width(400)
        ->height(400)
        ->format('webp')
        ->quality(90);

    // Hero image
    $this->addMediaConversion('hero')
        ->width(1920)
        ->height(1080)
        ->crop('crop-center', 1920, 1080)
        ->optimize();
}
```

### Available Manipulation Methods

```php
// Dimensions
->width(200)
->height(200)
->fit('contain', 300, 300)
->crop('crop-center', 400, 400)

// Quality & Format
->format('webp')
->quality(85)
->optimize()
->sharpen(10)

// Performance
->performOnCollections('images')     // Only for specific collection
->nonQueued()                        // Don't queue (instant)
->queued()                          // Queue for background processing

// Conditional
->withResponsiveImages()            // Generate responsive images
```

### Retrieving Conversions

```php
$media = $product->getFirstMedia('images');

// Get conversion URL
$thumbUrl = $media->getUrl('thumb');
$cardUrl = $media->getUrl('card');

// Check if conversion exists
if ($media->hasGeneratedConversion('thumb')) {
    $url = $media->getUrl('thumb');
}

// Get conversion path
$path = $media->getPath('thumb');
```

## Responsive Images

Generate responsive images for different screen sizes:

```php
public function registerMediaConversions(Media $media = null): void
{
    $this->addMediaConversion('responsive')
        ->width(1600)
        ->withResponsiveImages();
}
```

In Blade:

```blade
<picture>
    {{ $product->getFirstMedia('images')->img('responsive') }}
</picture>
```

Generates:

```html
<picture>
    <source srcset="/media/1/responsive_1920.jpg 1920w,
                     /media/1/responsive_1600.jpg 1600w,
                     /media/1/responsive_1280.jpg 1280w"
            type="image/jpeg">
    <img src="/media/1/responsive.jpg" alt="Product image">
</picture>
```

## Custom Properties

Store metadata with media:

```php
$product->addMedia($file)
    ->withCustomProperties([
        'alt_text' => 'Product photo',
        'photographer' => 'John Doe',
        'copyright' => '2025 Cartino'
    ])
    ->toMediaCollection('images');
```

Retrieve:

```php
$media = $product->getFirstMedia('images');

$altText = $media->getCustomProperty('alt_text');
$allProperties = $media->custom_properties;
```

Update:

```php
$media->setCustomProperty('alt_text', 'New alt text');
$media->save();
```

## Ordering Media

Media in collections are ordered:

```php
// Get ordered media
$orderedMedia = $product->getMedia('images'); // Already ordered

// Update order
$media = $product->getMedia('images')[0];
$media->order_column = 2;
$media->save();

// Or use helper
$mediaItems = $product->getMedia('images');
Media::setNewOrder($mediaItems->pluck('id')->toArray());
```

## Storage Disks

Configure storage location in `config/filesystems.php`:

```php
// Default: public disk
$product->addMedia($file)->toMediaCollection('images');

// Specific disk
$product->addMedia($file)
    ->toMediaCollection('images', 's3');
```

Cartino default configuration:

```php
// config/cartino.php
'media' => [
    'disk' => env('MEDIA_DISK', 'public'),
    'conversions_disk' => env('CONVERSIONS_DISK', 'public'),
],
```

## Working with Media URLs

### Temporary URLs (S3, etc.)

```php
// Generate temporary URL (expires in 5 minutes)
$url = $media->getTemporaryUrl(now()->addMinutes(5));

// With custom disk
$url = $media->getTemporaryUrl(
    now()->addMinutes(10),
    '',
    [
        'ResponseContentType' => 'application/pdf',
        'ResponseContentDisposition' => 'attachment; filename="document.pdf"'
    ]
);
```

### CDN Integration

Update `config/medialibrary.php`:

```php
'path_generator' => PathGenerator\DefaultPathGenerator::class,

'url_generator' => UrlGenerator\CustomCdnUrlGenerator::class,
```

Create custom URL generator:

```php
namespace App\Media;

use Spatie\MediaLibrary\Support\UrlGenerator\DefaultUrlGenerator;

class CustomCdnUrlGenerator extends DefaultUrlGenerator
{
    public function getUrl(): string
    {
        $url = parent::getUrl();

        return str_replace(
            config('app.url'),
            config('services.cdn.url'),
            $url
        );
    }
}
```

## API Integration

### Upload Endpoint

```php
// routes/api.php
Route::post('products/{product}/media', [ProductMediaController::class, 'upload']);
```

```php
// ProductMediaController.php
public function upload(Request $request, Product $product)
{
    $request->validate([
        'file' => 'required|image|max:5120', // 5MB
        'collection' => 'required|string|in:images,documents',
        'alt_text' => 'nullable|string|max:255',
    ]);

    $media = $product->addMediaFromRequest('file')
        ->withCustomProperties(['alt_text' => $request->alt_text])
        ->toMediaCollection($request->collection);

    return response()->json([
        'id' => $media->id,
        'url' => $media->getUrl(),
        'thumb_url' => $media->getUrl('thumb'),
    ]);
}
```

### List Media

```php
public function index(Product $product)
{
    $media = $product->getMedia('images')->map(function ($media) {
        return [
            'id' => $media->id,
            'name' => $media->file_name,
            'url' => $media->getUrl(),
            'thumb' => $media->getUrl('thumb'),
            'size' => $media->size,
            'mime_type' => $media->mime_type,
            'alt_text' => $media->getCustomProperty('alt_text'),
        ];
    });

    return response()->json($media);
}
```

### Delete Media

```php
public function destroy(Product $product, Media $media)
{
    // Ensure media belongs to product
    if ($media->model_id !== $product->id) {
        abort(403);
    }

    $media->delete();

    return response()->json(['message' => 'Media deleted successfully']);
}
```

## Performance Optimization

### Queue Conversions

Generate conversions in background:

```php
public function registerMediaConversions(Media $media = null): void
{
    $this->addMediaConversion('thumb')
        ->width(150)
        ->height(150)
        ->queued(); // Process in queue
}
```

Ensure queue worker is running:

```bash
php artisan queue:work
```

### Lazy Loading

```php
// Eager load media
$products = Product::with('media')->get();

// Lazy load specific collection
$product->load('media' => function ($query) {
    $query->where('collection_name', 'images');
});
```

### Caching

Cache media URLs:

```php
use Illuminate\Support\Facades\Cache;

$url = Cache::remember("product.{$product->id}.image", 3600, function () use ($product) {
    return $product->getFirstMediaUrl('images', 'thumb');
});
```

## Admin Panel Integration

### Product Image Upload

In your Inertia/Vue product form:

```vue
<template>
  <div>
    <input
      type="file"
      @change="uploadImage"
      accept="image/*"
      multiple
    />

    <div v-for="image in product.images" :key="image.id">
      <img :src="image.thumb" :alt="image.alt_text" />
      <button @click="deleteImage(image.id)">Delete</button>
    </div>
  </div>
</template>

<script setup>
import { router } from '@inertiajs/vue3'

const props = defineProps(['product'])

const uploadImage = async (event) => {
  const files = event.target.files
  const formData = new FormData()

  for (let file of files) {
    formData.append('file', file)
    formData.append('collection', 'images')

    await axios.post(`/api/products/${props.product.id}/media`, formData)
  }

  // Reload page to show new images
  router.reload()
}

const deleteImage = async (mediaId) => {
  if (confirm('Delete this image?')) {
    await axios.delete(`/api/products/${props.product.id}/media/${mediaId}`)
    router.reload()
  }
}
</script>
```

## Common Use Cases

### Product Gallery

```php
class Product extends Model implements HasMedia
{
    use InteractsWithMedia;

    public function registerMediaCollections(): void
    {
        $this->addMediaCollection('images')
            ->registerMediaConversions(function (Media $media) {
                $this->addMediaConversion('thumb')
                    ->width(200)
                    ->height(200);

                $this->addMediaConversion('large')
                    ->width(1200)
                    ->height(1200)
                    ->format('webp');
            });
    }

    // Helper method
    public function getGalleryImagesAttribute()
    {
        return $this->getMedia('images')->map(fn($media) => [
            'thumb' => $media->getUrl('thumb'),
            'large' => $media->getUrl('large'),
            'alt' => $media->getCustomProperty('alt_text', $this->name),
        ]);
    }
}
```

### Customer Avatar

```php
class Customer extends Model implements HasMedia
{
    use InteractsWithMedia;

    public function registerMediaCollections(): void
    {
        $this->addMediaCollection('avatar')
            ->singleFile()
            ->registerMediaConversions(function () {
                $this->addMediaConversion('thumb')
                    ->width(100)
                    ->height(100)
                    ->crop('crop-center', 100, 100);
            });
    }

    public function getAvatarUrlAttribute()
    {
        return $this->getFirstMediaUrl('avatar', 'thumb')
            ?: '/images/default-avatar.png';
    }
}
```

### Order Invoices

```php
class Order extends Model implements HasMedia
{
    use InteractsWithMedia;

    public function registerMediaCollections(): void
    {
        $this->addMediaCollection('invoices')
            ->acceptsMimeTypes(['application/pdf']);
    }

    public function generateInvoice()
    {
        $pdf = PDF::loadView('invoices.order', ['order' => $this]);
        $pdfPath = storage_path("temp/invoice-{$this->id}.pdf");
        $pdf->save($pdfPath);

        $this->addMedia($pdfPath)
            ->withCustomProperties([
                'invoice_number' => $this->invoice_number,
                'generated_at' => now(),
            ])
            ->toMediaCollection('invoices');

        unlink($pdfPath);
    }
}
```

## Troubleshooting

### Images Not Generating

```bash
# Check queue is running
php artisan queue:work

# Regenerate conversions
php artisan media-library:regenerate

# Check logs
tail -f storage/logs/laravel.log
```

### Permission Issues

```bash
# Fix storage permissions
chmod -R 775 storage/app/public
php artisan storage:link

# Fix media directory
chmod -R 775 storage/app/public/media
```

### Disk Space Issues

```bash
# Clear old media
php artisan media-library:clear

# Clear temporary conversions
php artisan media-library:clear --only-missing
```

## Advanced Topics

### Custom Path Generator

Control where files are stored:

```php
namespace App\Media;

use Spatie\MediaLibrary\MediaCollections\Models\Media;
use Spatie\MediaLibrary\Support\PathGenerator\PathGenerator;

class CustomPathGenerator implements PathGenerator
{
    public function getPath(Media $media): string
    {
        return $this->getBasePath($media) . '/';
    }

    public function getPathForConversions(Media $media): string
    {
        return $this->getBasePath($media) . '/conversions/';
    }

    public function getPathForResponsiveImages(Media $media): string
    {
        return $this->getBasePath($media) . '/responsive/';
    }

    protected function getBasePath(Media $media): string
    {
        // Organize by model type and month
        return $media->collection_name
            . '/' . $media->model_type
            . '/' . $media->created_at->format('Y/m');
    }
}
```

Register in `config/medialibrary.php`:

```php
'path_generator' => \App\Media\CustomPathGenerator::class,
```

### Custom File Namer

```php
namespace App\Media;

use Spatie\MediaLibrary\MediaCollections\Models\Media;
use Spatie\MediaLibrary\Support\FileNamer\FileNamer;

class CustomFileNamer extends FileNamer
{
    public function originalFileName(string $fileName): string
    {
        // Sanitize and add timestamp
        $name = pathinfo($fileName, PATHINFO_FILENAME);
        $extension = pathinfo($fileName, PATHINFO_EXTENSION);

        return Str::slug($name) . '-' . time() . '.' . $extension;
    }

    public function conversionFileName(string $fileName, string $conversionName): string
    {
        $name = pathinfo($fileName, PATHINFO_FILENAME);
        $extension = pathinfo($fileName, PATHINFO_EXTENSION);

        return $name . '-' . $conversionName . '.' . $extension;
    }
}
```

## Best Practices

### Security

```php
// Validate uploads
$request->validate([
    'image' => [
        'required',
        'image',
        'mimes:jpeg,png,webp',
        'max:5120', // 5MB
        'dimensions:max_width=4000,max_height=4000',
    ],
]);

// Sanitize file names
$media = $product->addMedia($file)
    ->sanitizingFileName(fn($fileName) => Str::slug($fileName))
    ->toMediaCollection('images');
```

### Performance

```php
// Use eager loading
$products = Product::with('media')->get();

// Queue conversions
$this->addMediaConversion('large')->queued();

// Use responsive images for web
->withResponsiveImages()
```

### Organization

```php
// Use collections to organize
- 'images' => Product photos
- 'documents' => PDFs, specs
- 'videos' => Product videos
- 'thumbnails' => Generated thumbs

// Use custom properties for metadata
->withCustomProperties([
    'alt_text' => '...',
    'photographer' => '...',
    'license' => '...',
])
```

## Resources

- [Spatie Media Library Official Docs](https://spatie.be/docs/laravel-medialibrary)
- [GitHub Repository](https://github.com/spatie/laravel-medialibrary)
- [Image Manipulation with Intervention](https://image.intervention.io/)
- [Responsive Images Guide](https://developer.mozilla.org/en-US/docs/Learn/HTML/Multimedia_and_embedding/Responsive_images)

## Next Steps

- **[Spatie Permissions →](/packages/permissions)** - Learn about role-based access control
- **[API Reference →](/api/rest)** - Use media endpoints in your API
- **[Admin Panel →](/user-guide/admin-panel)** - Media management in admin interface
