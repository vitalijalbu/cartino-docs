# Fields System & Blueprints

One of Cartino's most powerful features is the **Blueprint & Fields System**, inspired by [Statamic CMS](https://statamic.com/). This system allows you to create flexible, custom data structures without modifying your database schema.

## Introduction

The Fields System enables you to:
- ðŸ“ **Define custom fields** for any model (Products, Orders, Customers)
- ðŸ—‚ï¸ **Store data in JSONB columns** for flexibility
- ðŸŽ¨ **Reusable field definitions** via Fieldsets
- ðŸ”§ **Type-safe validation** with custom field types
- ðŸŒ **Admin UI generation** automatic form rendering
- ðŸ” **Query JSON data** efficiently with PostgreSQL

## Why Blueprints?

Traditional e-commerce platforms force you to modify database schema for custom fields. Cartino's Blueprint system stores custom data in a `fields` JSONB column, allowing:

- âœ… **No migrations needed** for new fields
- âœ… **Per-product-type customization** (T-shirts have "size", Electronics have "warranty")
- âœ… **Rapid prototyping** add/remove fields instantly
- âœ… **Type safety** built-in validation
- âœ… **Admin UI** forms auto-generate from blueprints

## Core Concepts

### 1. Blueprints

A **Blueprint** defines the structure of fields for a model instance. It's a YAML file that describes what fields are available.

Example: `blueprints/products/tshirt.yaml`

```yaml
title: T-Shirt
sections:
  details:
    display: Product Details
    fields:
      - handle: fabric
        field: fabric_type
      - handle: care_instructions
        field: markdown_field
  sizing:
    display: Sizing Information
    fields:
      - handle: size_chart
        field: size_chart_image
      - handle: fit_type
        field: fit_select
```

### 2. Fieldsets

A **Fieldset** is a reusable field definition that can be referenced in multiple blueprints.

Example: `fieldsets/fabric_type.yaml`

```yaml
handle: fabric_type
field:
  type: select
  display: Fabric Type
  instructions: Select the primary fabric material
  options:
    cotton: 100% Cotton
    polyester: Polyester
    blend: Cotton/Poly Blend
    linen: Linen
  validate:
    - required
```

### 3. Field Types

Built-in field types:

- `text` - Single line text input
- `textarea` - Multi-line text
- `markdown` - Markdown editor with preview
- `number` - Numeric input
- `select` - Dropdown selection
- `checkboxes` - Multiple selection
- `radio` - Single selection
- `toggle` - Boolean switch
- `date` - Date picker
- `time` - Time picker
- `datetime` - Date and time
- `color` - Color picker
- `assets` - File/image upload
- `relationship` - Related models
- `json` - Raw JSON editor
- `repeater` - Repeatable groups of fields

## Database Schema

### fields Column

Add a `fields` JSONB column to any model:

```php
Schema::table('products', function (Blueprint $table) {
    $table->jsonb('fields')->nullable();
    $table->index('fields', 'products_fields_gin')->algorithm('gin'); // For performance
});
```

### Casting

In your model:

```php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Cartino\Traits\HasFields;

class Product extends Model
{
    use HasFields;

    protected $casts = [
        'fields' => 'array',
    ];

    // Optional: Define blueprint
    public function blueprint(): string
    {
        return 'products.tshirt'; // Path to blueprint YAML
    }
}
```

## Creating Blueprints

### Directory Structure

```
resources/blueprints/
â”œâ”€â”€ products/
â”‚   â”œâ”€â”€ tshirt.yaml
â”‚   â”œâ”€â”€ electronics.yaml
â”‚   â”œâ”€â”€ book.yaml
â”‚   â””â”€â”€ default.yaml
â”œâ”€â”€ orders/
â”‚   â””â”€â”€ custom_order.yaml
â””â”€â”€ customers/
    â””â”€â”€ vip_customer.yaml
```

### Basic Blueprint

`resources/blueprints/products/tshirt.yaml`:

```yaml
title: T-Shirt Product
handle: tshirt

sections:
  main:
    display: Main Details
    fields:
      - handle: fabric
        field:
          type: select
          display: Fabric
          options:
            cotton: Cotton
            polyester: Polyester
          default: cotton
          validate: required

      - handle: gsm
        field:
          type: number
          display: GSM (Fabric Weight)
          instructions: Fabric weight in grams per square meter
          min: 100
          max: 300
          validate: required|numeric

      - handle: care_instructions
        field:
          type: markdown
          display: Care Instructions
          instructions: How to wash and care for this garment

  sizing:
    display: Sizing
    fields:
      - handle: fit_type
        field:
          type: select
          display: Fit
          options:
            slim: Slim Fit
            regular: Regular Fit
            relaxed: Relaxed Fit
          default: regular

      - handle: size_chart
        field:
          type: assets
          display: Size Chart Image
          max_files: 1
          container: products
```

### Using Fieldsets

Create reusable fieldsets:

`resources/fieldsets/seo.yaml`:

```yaml
handle: seo
fields:
  - handle: meta_title
    field:
      type: text
      display: Meta Title
      character_limit: 60

  - handle: meta_description
    field:
      type: textarea
      display: Meta Description
      character_limit: 160

  - handle: og_image
    field:
      type: assets
      display: Social Share Image
      max_files: 1
```

Reference in blueprint:

```yaml
sections:
  seo:
    display: SEO
    fields:
      - import: seo  # Import entire fieldset
```

## Built-in Field Types

### Text Field

```yaml
- handle: subtitle
  field:
    type: text
    display: Subtitle
    instructions: A short subtitle for the product
    placeholder: Enter subtitle...
    character_limit: 100
    validate:
      - required
      - max:100
```

### Textarea Field

```yaml
- handle: description
  field:
    type: textarea
    display: Description
    rows: 5
    character_limit: 500
    validate: required
```

### Markdown Field

```yaml
- handle: long_description
  field:
    type: markdown
    display: Long Description
    instructions: Full product description with formatting
    toolbar:
      - bold
      - italic
      - link
      - heading
      - code
```

### Number Field

```yaml
- handle: warranty_months
  field:
    type: number
    display: Warranty (Months)
    min: 0
    max: 60
    step: 1
    default: 12
    validate: required|numeric|min:0
```

### Select Field

```yaml
- handle: color
  field:
    type: select
    display: Color
    options:
      red: Red
      blue: Blue
      green: Green
      black: Black
    default: black
    validate: required
```

### Checkboxes Field

```yaml
- handle: features
  field:
    type: checkboxes
    display: Features
    options:
      waterproof: Waterproof
      breathable: Breathable
      windproof: Windproof
      stretchy: 4-Way Stretch
```

### Radio Field

```yaml
- handle: gender
  field:
    type: radio
    display: Gender
    options:
      male: Men's
      female: Women's
      unisex: Unisex
    default: unisex
    inline: true  # Display horizontally
```

### Toggle Field

```yaml
- handle: is_featured
  field:
    type: toggle
    display: Featured Product
    instructions: Show this product on homepage
    default: false
```

### Date/Time Fields

```yaml
- handle: release_date
  field:
    type: date
    display: Release Date
    mode: single  # single, range, multiple
    format: Y-m-d
    validate: required|date

- handle: event_time
  field:
    type: datetime
    display: Event Date & Time
    format: Y-m-d H:i
```

### Color Field

```yaml
- handle: brand_color
  field:
    type: color
    display: Brand Color
    default: '#3490dc'
    swatches:
      - '#3490dc'
      - '#f6993f'
      - '#e3342f'
```

### Assets Field

```yaml
- handle: product_images
  field:
    type: assets
    display: Product Images
    instructions: Upload product photos
    container: products
    folder: images
    max_files: 10
    mime_types:
      - image/jpeg
      - image/png
      - image/webp
    validate: required
```

### Relationship Field

```yaml
- handle: related_products
  field:
    type: relationship
    display: Related Products
    resource: products
    max_items: 5
    mode: default  # default, select, typeahead
```

### Repeater Field

```yaml
- handle: specifications
  field:
    type: repeater
    display: Specifications
    instructions: Add product specifications
    min_sets: 1
    max_sets: 20
    fields:
      - handle: spec_name
        field:
          type: text
          display: Name
          validate: required
      - handle: spec_value
        field:
          type: text
          display: Value
          validate: required
```

### JSON Field

```yaml
- handle: technical_data
  field:
    type: json
    display: Technical Data
    instructions: Raw JSON data for advanced users
```

## Working with Fields

### Setting Field Values

```php
$product = Product::find(1);

// Set single field
$product->setField('fabric', 'cotton');

// Set multiple fields
$product->setFields([
    'fabric' => 'cotton',
    'gsm' => 180,
    'care_instructions' => '# Washing\n\nMachine wash cold...',
]);

// Or directly
$product->fields = [
    'fabric' => 'cotton',
    'gsm' => 180,
];

$product->save();
```

### Getting Field Values

```php
// Get single field
$fabric = $product->getField('fabric');
// Returns: 'cotton'

// Get field with default
$fit = $product->getField('fit_type', 'regular');

// Get all fields
$allFields = $product->fields;
// Returns: ['fabric' => 'cotton', 'gsm' => 180, ...]

// Check if field exists
if ($product->hasField('fabric')) {
    // Field exists
}
```

### Validation

```php
// In controller
public function update(Request $request, Product $product)
{
    // Validate base fields
    $validated = $request->validate([
        'name' => 'required|string|max:255',
        'price' => 'required|numeric',
    ]);

    // Validate blueprint fields
    $fieldValues = $request->input('fields', []);
    $product->validateFields($fieldValues); // Throws ValidationException if invalid

    $product->update($validated);
    $product->setFields($fieldValues);
    $product->save();

    return redirect()->route('products.show', $product);
}
```

## Querying Fields

### Where Field Equals

```php
// PostgreSQL JSONB query
$products = Product::whereJsonContains('fields->fabric', 'cotton')->get();

// Or using query builder
$products = Product::where('fields->fabric', 'cotton')->get();
```

### Multiple Conditions

```php
$products = Product::where('fields->fabric', 'cotton')
    ->where('fields->gsm', '>=', 180)
    ->get();
```

### Order by Field

```php
$products = Product::orderBy('fields->gsm', 'desc')->get();
```

### Scope for Fields

```php
// In Product model
public function scopeByFabric($query, string $fabric)
{
    return $query->where('fields->fabric', $fabric);
}

public function scopeFabricWeight($query, int $min, int $max)
{
    return $query->whereBetween('fields->gsm', [$min, $max]);
}

// Usage
$cottonProducts = Product::byFabric('cotton')->get();
$heavyProducts = Product::fabricWeight(200, 300)->get();
```

## Admin Panel Integration

### Auto-Generated Forms

Cartino automatically generates admin forms from blueprints:

```vue
<template>
  <div class="blueprint-form">
    <h2>{{ blueprint.title }}</h2>

    <div v-for="section in blueprint.sections" :key="section.handle" class="section">
      <h3>{{ section.display }}</h3>

      <div v-for="field in section.fields" :key="field.handle" class="field">
        <label :for="field.handle">
          {{ field.field.display }}
          <span v-if="isRequired(field)" class="required">*</span>
        </label>

        <p v-if="field.field.instructions" class="instructions">
          {{ field.field.instructions }}
        </p>

        <!-- Render field based on type -->
        <component
          :is="getFieldComponent(field.field.type)"
          :id="field.handle"
          v-model="fields[field.handle]"
          v-bind="field.field"
        />

        <p v-if="errors[field.handle]" class="error">
          {{ errors[field.handle] }}
        </p>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue'
import TextField from '@/Components/Fields/TextField.vue'
import SelectField from '@/Components/Fields/SelectField.vue'
import MarkdownField from '@/Components/Fields/MarkdownField.vue'
// ... other field components

const props = defineProps(['blueprint', 'modelValue', 'errors'])
const fields = ref(props.modelValue || {})

const getFieldComponent = (type) => {
  const components = {
    text: TextField,
    select: SelectField,
    markdown: MarkdownField,
    // ... map all field types
  }
  return components[type] || TextField
}

const isRequired = (field) => {
  return field.field.validate?.includes('required')
}
</script>
```

### Field Components

Create Vue components for each field type:

```vue
<!-- Components/Fields/SelectField.vue -->
<template>
  <select
    :value="modelValue"
    @input="$emit('update:modelValue', $event.target.value)"
    :required="validate?.includes('required')"
  >
    <option value="">Select {{ display }}...</option>
    <option
      v-for="(label, value) in options"
      :key="value"
      :value="value"
    >
      {{ label }}
    </option>
  </select>
</template>

<script setup>
defineProps(['modelValue', 'display', 'options', 'validate'])
defineEmits(['update:modelValue'])
</script>
```

## Custom Field Types

### Create Custom Field Type

```php
namespace App\Fields;

use Cartino\Fields\Field;

class DimensionsField extends Field
{
    protected string $type = 'dimensions';

    public function process($value): array
    {
        // Validate and process incoming data
        return [
            'length' => (float) ($value['length'] ?? 0),
            'width' => (float) ($value['width'] ?? 0),
            'height' => (float) ($value['height'] ?? 0),
            'unit' => $value['unit'] ?? 'cm',
        ];
    }

    public function preload(): array
    {
        return [
            'units' => ['cm', 'in', 'm'],
        ];
    }

    public function rules(): array
    {
        return [
            'length' => 'required|numeric|min:0',
            'width' => 'required|numeric|min:0',
            'height' => 'required|numeric|min:0',
            'unit' => 'required|in:cm,in,m',
        ];
    }
}
```

### Register Custom Field

```php
// In AppServiceProvider
use Cartino\Facades\Fields;
use App\Fields\DimensionsField;

public function boot()
{
    Fields::register('dimensions', DimensionsField::class);
}
```

### Use in Blueprint

```yaml
- handle: package_dimensions
  field:
    type: dimensions
    display: Package Dimensions
    instructions: Enter product dimensions for shipping
    validate: required
```

### Vue Component for Custom Field

```vue
<!-- Components/Fields/DimensionsField.vue -->
<template>
  <div class="dimensions-field">
    <div class="input-group">
      <label>
        Length
        <input
          type="number"
          v-model.number="dimensions.length"
          @input="update"
          min="0"
          step="0.01"
        />
      </label>
      <label>
        Width
        <input
          type="number"
          v-model.number="dimensions.width"
          @input="update"
          min="0"
          step="0.01"
        />
      </label>
      <label>
        Height
        <input
          type="number"
          v-model.number="dimensions.height"
          @input="update"
          min="0"
          step="0.01"
        />
      </label>
      <label>
        Unit
        <select v-model="dimensions.unit" @change="update">
          <option value="cm">cm</option>
          <option value="in">in</option>
          <option value="m">m</option>
        </select>
      </label>
    </div>
  </div>
</template>

<script setup>
import { ref, watch } from 'vue'

const props = defineProps(['modelValue'])
const emit = defineEmits(['update:modelValue'])

const dimensions = ref(props.modelValue || {
  length: 0,
  width: 0,
  height: 0,
  unit: 'cm'
})

const update = () => {
  emit('update:modelValue', dimensions.value)
}
</script>
```

## Blueprint Conditions

Show/hide fields based on other field values:

```yaml
- handle: has_warranty
  field:
    type: toggle
    display: Has Warranty

- handle: warranty_months
  field:
    type: number
    display: Warranty Duration (Months)
    if:
      has_warranty: true  # Only show if has_warranty is true
```

```yaml
- handle: product_type
  field:
    type: select
    display: Product Type
    options:
      physical: Physical Product
      digital: Digital Product

- handle: weight
  field:
    type: number
    display: Weight (kg)
    if:
      product_type: physical  # Only for physical products

- handle: download_link
  field:
    type: text
    display: Download URL
    if:
      product_type: digital  # Only for digital products
```

## Import/Export

### Export Blueprint Data

```php
// Export product with fields
$product = Product::with('media')->find(1);

$export = [
    'name' => $product->name,
    'price' => $product->price,
    'fields' => $product->fields,
];

return response()->json($export);
```

### Import Blueprint Data

```php
// Import product
$data = json_decode($request->input('data'), true);

$product = Product::create([
    'name' => $data['name'],
    'price' => $data['price'],
]);

$product->setFields($data['fields']);
$product->save();
```

## Performance Optimization

### Index JSONB Fields

```php
Schema::table('products', function (Blueprint $table) {
    $table->index('fields', 'products_fields_gin')->algorithm('gin');
});
```

### Cache Blueprint Definitions

```php
use Illuminate\Support\Facades\Cache;

$blueprint = Cache::remember('blueprint:products.tshirt', 3600, function () {
    return Blueprint::load('products/tshirt');
});
```

### Eager Load Fields

```php
// Instead of N+1 queries
$products = Product::all();
foreach ($products as $product) {
    echo $product->getField('fabric'); // N+1!
}

// Better: Load all at once
$products = Product::all();
// Fields are already loaded in the model
```

## Best Practices

### 1. Use Fieldsets for Reusability

```yaml
# âœ… Good: Reusable fieldset
fieldsets/seo.yaml
fieldsets/shipping_details.yaml

# âŒ Bad: Duplicate fields in every blueprint
```

### 2. Validate Fields

Always validate blueprint field data:

```php
$product->validateFields($fieldData);
```

### 3. Keep Blueprints Organized

```
blueprints/
â”œâ”€â”€ products/
â”‚   â”œâ”€â”€ physical.yaml
â”‚   â”œâ”€â”€ digital.yaml
â”‚   â””â”€â”€ subscription.yaml
```

### 4. Document Field Instructions

```yaml
instructions: Clear description of what this field is for
```

### 5. Use Sensible Defaults

```yaml
default: regular  # Provide default values
```

## Troubleshooting

### Fields Not Saving

Check that model has `HasFields` trait and `fields` cast:

```php
use Cartino\Traits\HasFields;

protected $casts = [
    'fields' => 'array',
];
```

### Blueprint Not Found

Ensure blueprint file exists:

```bash
ls -la resources/blueprints/products/tshirt.yaml
```

### Query Not Working

PostgreSQL required for JSONB:

```bash
# Check database
php artisan tinker
>>> DB::select('SELECT version()');
```

## Resources

- [Statamic Blueprints Documentation](https://statamic.dev/blueprints)
- [PostgreSQL JSONB](https://www.postgresql.org/docs/current/datatype-json.html)
- [Laravel JSON Columns](https://laravel.com/docs/queries#json-where-clauses)

## Next Steps

- **[Admin Panel â†’](/admin)** - See blueprints in action
- **[Extending Backend â†’](/extending/backend)** - Create custom fields
- **[API Reference â†’](/api/rest)** - Query fields via API
